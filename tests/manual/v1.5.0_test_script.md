# Manual Test Script: v1.5.0 - Hybrid Pipeline

## Prerequisites

### Required
- [ ] Ollama installed and running (`ollama serve`)
- [ ] Local model available (e.g., `llama3.2:3b` or larger)
- [ ] Frontier API key configured (Anthropic or OpenAI) for hybrid tests

### Optional
- [ ] Privacy extras for anonymisation tests (`pip install persona[privacy]`)

---

## F-116: Hybrid Local/Frontier Pipeline

### Test 1: Basic Hybrid Generation
```bash
# Create test data
cat > /tmp/research_data.csv << 'EOF'
feedback,context
"App loads slowly on mobile","User testing session"
"Love the new dark mode","Feature feedback"
"Search results not relevant","Support ticket"
EOF

persona generate --input /tmp/research_data.csv --hybrid --count 2
```
- [ ] Generation starts with local drafts
- [ ] Progress shows draft generation phase
- [ ] Progress shows quality filtering phase
- [ ] Progress shows frontier refinement phase
- [ ] Final personas created
- [ ] Cost report displayed

### Test 2: Specify Local Model
```bash
persona generate --input /tmp/research_data.csv --hybrid --local-model llama3.2:3b --count 2
```
- [ ] Uses specified local model
- [ ] Generation completes successfully

### Test 3: Specify Frontier Provider
```bash
persona generate --input /tmp/research_data.csv --hybrid --frontier anthropic --count 2
```
- [ ] Uses Anthropic for refinement
- [ ] API calls only for refinement phase

### Test 4: Budget Constraint
```bash
persona generate --input /tmp/research_data.csv --hybrid --max-cost 0.50 --count 5
```
- [ ] Respects budget limit
- [ ] Warning if budget would be exceeded
- [ ] Falls back to local-only if over budget
- [ ] Final cost <= $0.50

### Test 5: Cost Estimation Only
```bash
persona generate --input /tmp/research_data.csv --hybrid --estimate-only --count 10
```
- [ ] Shows estimated cost breakdown
- [ ] No actual generation performed
- [ ] Shows local vs frontier cost split

### Test 6: Local-Only Mode (Privacy)
```bash
persona generate --input /tmp/research_data.csv --hybrid --no-frontier --count 3
```
- [ ] No frontier API calls
- [ ] All generation uses local model
- [ ] Cost is $0.00
- [ ] Quality may be lower (expected)

### Test 7: Custom Draft Multiplier
```bash
persona generate --input /tmp/research_data.csv --hybrid --draft-multiplier 3 --count 2
```
- [ ] Generates 6 drafts (3 × 2)
- [ ] Filters to top 2
- [ ] Better selection from larger pool

### Test 8: Custom Quality Threshold
```bash
persona generate --input /tmp/research_data.csv --hybrid --quality-threshold 0.85 --count 3
```
- [ ] Only drafts scoring >= 0.85 proceed
- [ ] Higher threshold = more filtering
- [ ] May use more frontier calls if few pass

### Test 9: Combined Options
```bash
persona generate --input /tmp/research_data.csv --hybrid \
  --local-model llama3.2:3b \
  --frontier anthropic \
  --draft-multiplier 2 \
  --quality-threshold 0.75 \
  --max-cost 2.00 \
  --count 5
```
- [ ] All options respected
- [ ] Generation completes within budget
- [ ] Quality threshold applied

### Test 10: Hybrid with Anonymisation
```bash
cat > /tmp/sensitive_data.csv << 'EOF'
name,email,feedback
John Smith,john@example.com,"Great product experience"
Sarah Jones,sarah@test.org,"Needs mobile improvements"
EOF

persona generate --input /tmp/sensitive_data.csv --hybrid --anonymise --count 2
```
- [ ] Input anonymised before local processing
- [ ] PII not sent to frontier
- [ ] Output personas don't contain source PII

---

## Cost Comparison Tests

### Test 11: Frontier-Only Baseline
```bash
persona generate --input /tmp/research_data.csv --provider anthropic --count 3
echo "Note the cost"
```
- [ ] Note total cost for comparison

### Test 12: Hybrid Cost Comparison
```bash
persona generate --input /tmp/research_data.csv --hybrid --count 3
echo "Compare cost to frontier-only"
```
- [ ] Cost should be lower than frontier-only
- [ ] Quality should be similar (90%+)

### Test 13: Local-Only Cost Comparison
```bash
persona generate --input /tmp/research_data.csv --hybrid --no-frontier --count 3
```
- [ ] Cost is $0.00
- [ ] Quality lower but acceptable

---

## Error Handling

### Test 14: Local Provider Unavailable
```bash
# Stop Ollama
ollama stop

persona generate --input /tmp/research_data.csv --hybrid --count 2
```
- [ ] Clear error about Ollama not running
- [ ] Suggests starting Ollama or using --no-local

### Test 15: Local Unavailable with Frontier Fallback
```bash
# With Ollama stopped
persona generate --input /tmp/research_data.csv --hybrid --count 2
# Should offer to continue with frontier-only
```
- [ ] Warning about local provider unavailable
- [ ] Option to continue frontier-only
- [ ] Or clear error if --no-frontier specified

### Test 16: Budget Exceeded Warning
```bash
persona generate --input /tmp/research_data.csv --hybrid --max-cost 0.01 --count 10
```
- [ ] Warning that budget would be exceeded
- [ ] Suggests reducing count or increasing budget
- [ ] Falls back to local-only or fails gracefully

### Test 17: Invalid Options
```bash
persona generate --input /tmp/research_data.csv --hybrid --draft-multiplier 0
```
- [ ] Clear error about invalid multiplier
- [ ] Must be >= 1

### Test 18: Help Command
```bash
persona generate --help | grep -A5 "hybrid"
```
- [ ] Hybrid options documented
- [ ] Examples provided

---

## Performance Tests

### Test 19: Bulk Generation
```bash
# Create larger dataset
for i in {1..20}; do
  echo "\"Feedback item $i\",\"Context $i\""
done > /tmp/bulk_data.csv
echo "feedback,context" | cat - /tmp/bulk_data.csv > /tmp/temp && mv /tmp/temp /tmp/bulk_data.csv

time persona generate --input /tmp/bulk_data.csv --hybrid --count 10
```
- [ ] Completes in reasonable time
- [ ] Progress feedback throughout
- [ ] Cost tracking accurate

### Test 20: Parallel Draft Generation
```bash
persona generate --input /tmp/research_data.csv --hybrid --draft-multiplier 4 --count 5 -v
```
- [ ] Verbose shows parallel draft generation
- [ ] Multiple drafts generated concurrently
- [ ] Filtering shows scores for all drafts

---

## Integration Tests

### Test 21: Full Privacy-Preserving Workflow
```bash
# Sensitive input → anonymise → local drafts → local filtering → optional frontier
cat > /tmp/interview_data.csv << 'EOF'
participant,email,quote
"Dr. Jane Doe",jane.doe@hospital.org,"Patient care is our priority"
"Mr. Bob Smith",bob@clinic.com,"Wait times are too long"
EOF

persona generate --input /tmp/interview_data.csv \
  --hybrid \
  --anonymise \
  --no-frontier \
  --count 3

# Verify no PII in output
cat output/*/personas.json | grep -i "jane\|bob\|hospital\|clinic"
```
- [ ] Input anonymised
- [ ] All processing local
- [ ] No PII in output
- [ ] Personas are useful despite anonymisation

### Test 22: Quality Validation After Hybrid
```bash
persona generate --input /tmp/research_data.csv --hybrid --count 3 --output /tmp/hybrid_output

persona evaluate /tmp/hybrid_output/personas.json --judge ollama
```
- [ ] Hybrid personas pass quality evaluation
- [ ] Scores >= 0.75 for coherence, realism

---

## Cleanup

```bash
rm -f /tmp/research_data.csv /tmp/sensitive_data.csv
rm -f /tmp/bulk_data.csv /tmp/interview_data.csv
rm -rf /tmp/hybrid_output
```

---

## Test Results Summary

| Test | Pass | Fail | Notes |
|------|------|------|-------|
| 1. Basic Hybrid | | | |
| 2. Specify Local Model | | | |
| 3. Specify Frontier | | | |
| 4. Budget Constraint | | | |
| 5. Cost Estimation | | | |
| 6. Local-Only Mode | | | |
| 7. Draft Multiplier | | | |
| 8. Quality Threshold | | | |
| 9. Combined Options | | | |
| 10. With Anonymisation | | | |
| 11. Frontier Baseline | | | |
| 12. Hybrid Cost Compare | | | |
| 13. Local-Only Cost | | | |
| 14. Local Unavailable | | | |
| 15. Frontier Fallback | | | |
| 16. Budget Exceeded | | | |
| 17. Invalid Options | | | |
| 18. Help Command | | | |
| 19. Bulk Generation | | | |
| 20. Parallel Drafts | | | |
| 21. Privacy Workflow | | | |
| 22. Quality Validation | | | |

**Tester:** _______________
**Date:** _______________
**Version:** v1.5.0
**Platform:** _______________

---

## Cost Tracking

| Test | Estimated | Actual | Savings vs Frontier |
|------|-----------|--------|---------------------|
| Hybrid (3 personas) | | | |
| Local-only (3 personas) | $0.00 | $0.00 | 100% |
| Frontier-only baseline | | | 0% |
