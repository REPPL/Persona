# Manual Test Script: REST API & Webhooks (F-089, F-090)

This script verifies the REST API and webhook functionality. Execute tests in order and record results.

## Prerequisites

- Python 3.12+
- Persona installed with `pip install -e ".[all,api]"`

## Setup

```bash
# 1. Activate virtual environment
source .venv-test/bin/activate  # On Windows: .venv-test\Scripts\activate

# 2. Install API dependencies
pip install "fastapi>=0.115.0" "uvicorn[standard]>=0.32.0"

# 3. Verify installation
persona --version
```

**Expected:** Shows Persona version

---

## Test 1: API Module Import

**Command:**
```python
from persona.api import create_app
from persona.api.routes import generate, experiments, health

print("API imports successful")
```

**Expected:** All API modules importable

**Pass Criteria:**
- [ ] create_app importable
- [ ] Routes importable
- [ ] No import errors

---

## Test 2: Server CLI Command

**Command:**
```bash
persona serve --help
```

**Expected:** Shows help for serve command

**Pass Criteria:**
- [ ] Command exists
- [ ] --host flag documented
- [ ] --port flag documented
- [ ] --reload flag documented

---

## Test 3: Start Server

**Command:**
```bash
# Start server in background
persona serve --port 8000 &
sleep 3

# Check if running
curl http://localhost:8000/api/v1/health
```

**Expected:** Server starts and responds to health check

**Pass Criteria:**
- [ ] Server starts without errors
- [ ] Health endpoint responds
- [ ] Returns JSON with status

---

## Test 4: OpenAPI Documentation

**Command:**
```bash
# Access OpenAPI docs
curl http://localhost:8000/docs
curl http://localhost:8000/openapi.json
```

**Expected:** OpenAPI documentation available

**Pass Criteria:**
- [ ] /docs returns Swagger UI
- [ ] /openapi.json returns schema
- [ ] All endpoints documented

---

## Test 5: Generate Endpoint

**Command:**
```bash
curl -X POST http://localhost:8000/api/v1/generate \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer test-key" \
  -d '{
    "data_path": "./examples/sample_data.csv",
    "count": 2,
    "provider": "anthropic"
  }'
```

**Expected:** Returns generation job ID

**Pass Criteria:**
- [ ] Returns 202 Accepted or 200 OK
- [ ] Returns job_id in response
- [ ] Validates request body

---

## Test 6: Get Job Status

**Command:**
```bash
# Using job_id from previous test
curl http://localhost:8000/api/v1/generate/{job_id} \
  -H "Authorization: Bearer test-key"
```

**Expected:** Returns generation status

**Pass Criteria:**
- [ ] Returns status (pending/running/completed/failed)
- [ ] Shows progress if running
- [ ] Returns personas when completed

---

## Test 7: List Experiments

**Command:**
```bash
curl http://localhost:8000/api/v1/experiments \
  -H "Authorization: Bearer test-key"
```

**Expected:** Returns list of experiments

**Pass Criteria:**
- [ ] Returns array of experiments
- [ ] Each has id, status, created_at
- [ ] Supports pagination

---

## Test 8: Get Experiment Details

**Command:**
```bash
curl http://localhost:8000/api/v1/experiments/{experiment_id} \
  -H "Authorization: Bearer test-key"
```

**Expected:** Returns experiment details

**Pass Criteria:**
- [ ] Returns full experiment data
- [ ] Includes personas
- [ ] Includes metadata

---

## Test 9: Quality Score Endpoint

**Command:**
```bash
curl -X POST http://localhost:8000/api/v1/quality/score \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer test-key" \
  -d '{
    "personas": [{"name": "Test", "goals": ["Test goal"]}]
  }'
```

**Expected:** Returns quality scores

**Pass Criteria:**
- [ ] Returns quality scores
- [ ] Includes overall score
- [ ] Includes dimension breakdown

---

## Test 10: List Plugins Endpoint

**Command:**
```bash
curl http://localhost:8000/api/v1/plugins \
  -H "Authorization: Bearer test-key"
```

**Expected:** Returns list of plugins

**Pass Criteria:**
- [ ] Returns plugin list
- [ ] Includes formatters, loaders, providers
- [ ] Shows enabled status

---

## Test 11: Authentication

**Command:**
```bash
# Without auth header
curl http://localhost:8000/api/v1/experiments

# With invalid key
curl http://localhost:8000/api/v1/experiments \
  -H "Authorization: Bearer invalid-key"
```

**Expected:** Returns 401 Unauthorized

**Pass Criteria:**
- [ ] 401 without auth header
- [ ] 401 with invalid key
- [ ] Clear error message

---

## Test 12: Rate Limiting

**Command:**
```bash
# Rapid requests
for i in {1..20}; do
  curl -s http://localhost:8000/api/v1/health &
done
wait
```

**Expected:** Rate limiting applied after threshold

**Pass Criteria:**
- [ ] Returns 429 when rate exceeded
- [ ] Includes Retry-After header
- [ ] Resets after wait period

---

## Test 13: Webhook Registration (F-090)

**Command:**
```bash
curl -X POST http://localhost:8000/api/v1/webhooks \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer test-key" \
  -d '{
    "url": "https://webhook.site/test",
    "events": ["generation.completed", "generation.failed"],
    "secret": "webhook-secret"
  }'
```

**Expected:** Webhook registered

**Pass Criteria:**
- [ ] Returns webhook ID
- [ ] Validates URL
- [ ] Supports multiple events

---

## Test 14: Webhook Delivery

**Command:**
```bash
# Trigger generation and check webhook delivery
# Use webhook.site or similar to verify

curl -X POST http://localhost:8000/api/v1/generate \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer test-key" \
  -d '{
    "data_path": "./examples/sample_data.csv",
    "count": 1
  }'

# Check webhook.site for delivery
```

**Expected:** Webhook delivered on completion

**Pass Criteria:**
- [ ] Webhook delivered to URL
- [ ] X-Persona-Signature header present
- [ ] Payload matches event type

---

## Test 15: Webhook Signature Verification

**Command:**
```python
import hmac
import hashlib

# Example signature verification
payload = '{"event": "generation.completed"}'
secret = "webhook-secret"
signature = hmac.new(
    secret.encode(),
    payload.encode(),
    hashlib.sha256
).hexdigest()

print(f"Expected signature: {signature}")
```

**Expected:** HMAC-SHA256 signature valid

**Pass Criteria:**
- [ ] Signature matches payload
- [ ] Uses SHA256 algorithm
- [ ] Secret properly applied

---

## Test 16: Documentation Check

**Command:**
```bash
# Check feature specs exist
ls docs/development/roadmap/features/completed/F-089-rest-api.md
ls docs/development/roadmap/features/completed/F-090-webhooks.md

# Check guide exists
ls docs/guides/api-guide.md

echo "Exit code: $?"
```

**Expected:** Documentation exists

**Pass Criteria:**
- [ ] F-089 feature spec created
- [ ] F-090 feature spec created
- [ ] API guide created
- [ ] Webhook examples included

---

## Cleanup

```bash
# Stop server
pkill -f "persona serve"
```

---

## Results Summary

| Test | Status |
|------|--------|
| Test 1: Import | [ ] |
| Test 2: CLI Command | [ ] |
| Test 3: Start Server | [ ] |
| Test 4: OpenAPI Docs | [ ] |
| Test 5: Generate | [ ] |
| Test 6: Job Status | [ ] |
| Test 7: List Experiments | [ ] |
| Test 8: Experiment Details | [ ] |
| Test 9: Quality Score | [ ] |
| Test 10: List Plugins | [ ] |
| Test 11: Authentication | [ ] |
| Test 12: Rate Limiting | [ ] |
| Test 13: Webhook Reg | [ ] |
| Test 14: Webhook Delivery | [ ] |
| Test 15: Webhook Signature | [ ] |
| Test 16: Documentation | [ ] |

**Tested by:** ________________
**Date:** ________________
**API Version:** ________________
**Notes:**
