# Manual Test Script: Async Support (F-088)

This script verifies the async infrastructure functionality. Execute tests in order and record results.

## Prerequisites

- Python 3.12+
- Persona installed with `pip install -e ".[all]"`

## Setup

```bash
# 1. Activate virtual environment
source .venv-test/bin/activate  # On Windows: .venv-test\Scripts\activate

# 2. Verify installation
persona --version
```

**Expected:** Shows Persona version

---

## Test 1: Async Utilities Import

**Command:**
```python
from persona.core.async_utils import (
    AsyncRateLimiter,
    async_retry,
    run_concurrent,
)
print("Import successful")
```

**Expected:** No import errors

**Pass Criteria:**
- [ ] All async utilities importable
- [ ] No dependency errors
- [ ] Module structure correct

---

## Test 2: Async Provider Interface

**Command:**
```python
from persona.core.providers.base import LLMProvider
import inspect

# Check async methods exist
assert hasattr(LLMProvider, 'generate_async')
assert inspect.iscoroutinefunction(LLMProvider.generate_async)
print("Async interface verified")
```

**Expected:** Async methods exist on base provider

**Pass Criteria:**
- [ ] generate_async method exists
- [ ] Method is a coroutine function
- [ ] Backward compatible with sync interface

---

## Test 3: Async OpenAI Provider

**Command:**
```python
import asyncio
from persona.core.providers.openai import OpenAIProvider

async def test_async():
    provider = OpenAIProvider(api_key="test-key")
    # Just verify method exists and is async
    assert hasattr(provider, 'generate_async')
    print("OpenAI async support verified")

asyncio.run(test_async())
```

**Expected:** OpenAI provider has async support

**Pass Criteria:**
- [ ] OpenAI provider has generate_async
- [ ] Anthropic provider has generate_async
- [ ] Gemini provider has generate_async

---

## Test 4: Async Rate Limiter

**Command:**
```python
import asyncio
from persona.core.async_utils import AsyncRateLimiter

async def test_rate_limiter():
    limiter = AsyncRateLimiter(requests_per_minute=60)

    # Acquire should work
    await limiter.acquire()
    print("Rate limiter working")

asyncio.run(test_rate_limiter())
```

**Expected:** Rate limiter controls async request flow

**Pass Criteria:**
- [ ] Rate limiter initialises correctly
- [ ] Acquire method works
- [ ] Respects rate limits

---

## Test 5: Async Retry Decorator

**Command:**
```python
import asyncio
from persona.core.async_utils import async_retry

call_count = 0

@async_retry(max_attempts=3, delay=0.1)
async def flaky_function():
    global call_count
    call_count += 1
    if call_count < 3:
        raise ValueError("Temporary error")
    return "success"

async def test_retry():
    result = await flaky_function()
    assert result == "success"
    assert call_count == 3
    print("Retry decorator working")

asyncio.run(test_retry())
```

**Expected:** Retry decorator retries on failure

**Pass Criteria:**
- [ ] Retries specified number of times
- [ ] Exponential backoff working
- [ ] Returns success on eventual success

---

## Test 6: Concurrent Execution

**Command:**
```python
import asyncio
from persona.core.async_utils import run_concurrent

async def task(n):
    await asyncio.sleep(0.01)
    return n * 2

async def test_concurrent():
    tasks = [task(i) for i in range(5)]
    results = await run_concurrent(tasks, max_concurrent=3)
    assert results == [0, 2, 4, 6, 8]
    print("Concurrent execution working")

asyncio.run(test_concurrent())
```

**Expected:** Concurrent tasks execute with concurrency limit

**Pass Criteria:**
- [ ] Tasks run concurrently
- [ ] Respects max_concurrent limit
- [ ] Results returned in order

---

## Test 7: Async Data Loading

**Command:**
```python
import asyncio
from persona.core.data.loader import DataLoader

async def test_async_load():
    loader = DataLoader()
    # Check async method exists
    assert hasattr(loader, 'load_async')
    print("Async data loading available")

asyncio.run(test_async_load())
```

**Expected:** DataLoader has async loading support

**Pass Criteria:**
- [ ] load_async method exists
- [ ] Works with all supported formats
- [ ] Backward compatible with sync load

---

## Test 8: Async Generation Pipeline

**Command:**
```python
import asyncio
from persona.core.generation.generator import PersonaGenerator

async def test_async_generation():
    # Check async method exists
    assert hasattr(PersonaGenerator, 'generate_async')
    print("Async generation pipeline available")

asyncio.run(test_async_generation())
```

**Expected:** Generator has async support

**Pass Criteria:**
- [ ] generate_async method exists
- [ ] Supports concurrent persona generation
- [ ] Progress tracking works async

---

## Test 9: Backward Compatibility

**Command:**
```python
from persona.core.providers.openai import OpenAIProvider
from persona.core.generation.generator import PersonaGenerator
from persona.core.data.loader import DataLoader

# All sync methods should still work
provider = OpenAIProvider(api_key="test")
assert hasattr(provider, 'generate')

loader = DataLoader()
assert hasattr(loader, 'load')

print("Backward compatibility verified")
```

**Expected:** All sync interfaces unchanged

**Pass Criteria:**
- [ ] Sync provider.generate() works
- [ ] Sync loader.load() works
- [ ] Sync generator.generate() works
- [ ] No breaking changes

---

## Test 10: Documentation Check

**Command:**
```bash
# Check feature spec exists
ls docs/development/roadmap/features/completed/F-088-async-support.md
echo "Exit code: $?"
```

**Expected:** Feature spec exists

**Pass Criteria:**
- [ ] Feature spec created
- [ ] Docstrings on all async methods
- [ ] Examples in documentation

---

## Results Summary

| Test | Status |
|------|--------|
| Test 1: Import | [ ] |
| Test 2: Provider Interface | [ ] |
| Test 3: OpenAI Async | [ ] |
| Test 4: Rate Limiter | [ ] |
| Test 5: Retry Decorator | [ ] |
| Test 6: Concurrent Execution | [ ] |
| Test 7: Async Data Loading | [ ] |
| Test 8: Async Generation | [ ] |
| Test 9: Backward Compatibility | [ ] |
| Test 10: Documentation | [ ] |

**Tested by:** ________________
**Date:** ________________
**Notes:**
