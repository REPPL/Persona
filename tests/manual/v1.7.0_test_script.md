# Manual Test Script: v1.7.0 - Quality Assurance Suite

## Prerequisites

### Environment Setup
- [ ] Python 3.12+ installed
- [ ] Virtual environment activated (`.venv/`)
- [ ] All dependencies installed (`pip install -e ".[all]"`)

### For LLM-based Tests
- [ ] At least one LLM provider configured (Ollama recommended for local testing)
- [ ] For multi-model verification: multiple providers/models available

### Test Data
```bash
# Create test personas for quality assessment
mkdir -p /tmp/persona_test

cat > /tmp/persona_test/personas.json << 'EOF'
[
  {
    "id": "persona-1",
    "name": "Sarah Mitchell",
    "demographics": {
      "age": 32,
      "gender": "female",
      "occupation": "Software Engineer",
      "location": "London"
    },
    "behaviours": [
      "Reviews code methodically",
      "Documents everything",
      "Mentors junior developers"
    ],
    "goals": [
      "Lead a development team",
      "Improve system architecture"
    ],
    "pain_points": [
      "Technical debt in legacy systems",
      "Meeting overload"
    ],
    "quote": "Good architecture today prevents problems tomorrow."
  },
  {
    "id": "persona-2",
    "name": "Marcus Chen",
    "demographics": {
      "age": 45,
      "gender": "male",
      "occupation": "Project Manager",
      "location": "San Francisco"
    },
    "behaviours": [
      "Very emotional about deadlines",
      "Naturally good at leading men",
      "Tech-savvy despite his age"
    ],
    "goals": [
      "Deliver projects on time",
      "Build high-performing teams"
    ],
    "pain_points": [
      "Resource constraints",
      "Stakeholder alignment"
    ],
    "quote": "A team's success is measured by its outcomes."
  }
]
EOF

# Create test data file
cat > /tmp/persona_test/interview.txt << 'EOF'
Interview with John Smith on 15/03/2024.
Contact: john.smith@example.com

John mentioned he finds the checkout process frustrating.
"I always have to re-enter my details, it's very annoying"

He's been using the app for 6 months and likes the design
but wishes it was faster on his older phone.
EOF
```

---

## F-119: Bias & Stereotype Detection

### Test 1: Bias Help Commands
```bash
persona bias --help
persona bias check --help
persona bias report --help
```
- [ ] Help text displays correctly
- [ ] Commands documented
- [ ] Options explained

### Test 2: Bias Check - Lexicon Method
```bash
persona bias check /tmp/persona_test/personas.json --methods lexicon
```
- [ ] Scans both personas
- [ ] Detects bias in persona-2 ("Very emotional", "Naturally good at leading men", "despite his age")
- [ ] Shows severity levels (Low/Medium/High)
- [ ] Shows bias score

### Test 3: Bias Check - JSON Output
```bash
persona bias check /tmp/persona_test/personas.json --methods lexicon --output json
```
- [ ] Valid JSON output
- [ ] Contains findings array
- [ ] Contains category_scores
- [ ] Contains overall_score per persona

### Test 4: Bias Check - Multiple Categories
```bash
persona bias check /tmp/persona_test/personas.json --categories gender,age,professional
```
- [ ] Checks specified categories only
- [ ] Reports by category

### Test 5: Bias Check - High Threshold
```bash
persona bias check /tmp/persona_test/personas.json --threshold 0.9
```
- [ ] Fewer findings with higher threshold
- [ ] Only high-confidence matches

### Test 6: Bias Check - Max Score Gate
```bash
persona bias check /tmp/persona_test/personas.json --max-score 0.1
```
- [ ] Exit code non-zero if bias exceeds threshold
- [ ] Error message displayed

### Test 7: Bias Report Generation
```bash
persona bias report /tmp/persona_test/personas.json --output /tmp/bias_report.md --format markdown
```
- [ ] Report file created
- [ ] Contains summary section
- [ ] Contains findings details
- [ ] Markdown formatting correct

### Test 8: Bias Check - Clean Persona
```bash
# Check persona-1 only (should be clean)
cat > /tmp/persona_test/clean_persona.json << 'EOF'
{
  "id": "clean-1",
  "name": "Alex Thompson",
  "demographics": {"age": 35, "occupation": "Designer"},
  "behaviours": ["Focuses on user needs", "Iterates on feedback"],
  "goals": ["Create intuitive interfaces"],
  "pain_points": ["Limited user research time"]
}
EOF

persona bias check /tmp/persona_test/clean_persona.json
```
- [ ] Low or zero bias score
- [ ] Minimal findings

---

## F-120: Multi-Model Verification

### Test 9: Verify Help Command
```bash
persona verify --help
```
- [ ] Help text displays correctly
- [ ] Shows model options
- [ ] Shows voting strategies

### Test 10: Self-Consistency Check (Single Model)
```bash
# Requires Ollama running with a model
persona verify /tmp/persona_test/interview.txt --self-consistency --samples 3 --count 1
```
- [ ] Generates multiple samples from same model
- [ ] Calculates consistency score
- [ ] Shows field-level agreement

### Test 11: Multi-Model Verification
```bash
# Requires multiple providers configured
persona verify /tmp/persona_test/interview.txt \
  --models ollama/llama3.2:3b,ollama/gemma:2b \
  --samples 2 \
  --count 1 \
  --strategy majority
```
- [ ] Generates samples from each model
- [ ] Cross-model comparison performed
- [ ] Voting results displayed
- [ ] Consistency metrics shown

### Test 12: Verification Report
```bash
persona verify /tmp/persona_test/interview.txt \
  --self-consistency \
  --samples 3 \
  --report /tmp/verify_report.md
```
- [ ] Report file created
- [ ] Contains methodology section
- [ ] Contains results table
- [ ] Contains recommendations

### Test 13: Verification Threshold
```bash
persona verify /tmp/persona_test/interview.txt \
  --self-consistency \
  --threshold 0.9
```
- [ ] Higher threshold = stricter pass criteria
- [ ] Pass/fail status reflects threshold

---

## F-121: Lexical Diversity Metrics

### Test 14: Diversity Help Command
```bash
persona diversity --help
persona diversity analyse --help
```
- [ ] Help text displays correctly
- [ ] Metrics explained

### Test 15: Diversity Analysis
```bash
persona diversity analyse /tmp/persona_test/personas.json
```
- [ ] Analyses both personas
- [ ] Shows TTR (Type-Token Ratio)
- [ ] Shows vocabulary richness metrics
- [ ] Shows aggregate statistics

### Test 16: Diversity - JSON Output
```bash
persona diversity analyse /tmp/persona_test/personas.json --output json
```
- [ ] Valid JSON output
- [ ] Contains per-persona metrics
- [ ] Contains aggregate metrics

### Test 17: Diversity - Field-Specific Analysis
```bash
persona diversity analyse /tmp/persona_test/personas.json --fields behaviours,goals
```
- [ ] Analyses only specified fields
- [ ] Shows field-level diversity

### Test 18: Diversity Thresholds
```bash
persona diversity analyse /tmp/persona_test/personas.json --min-ttr 0.5
```
- [ ] Flags personas below threshold
- [ ] Shows recommendations

---

## F-122: Prompt Fidelity Scoring

### Test 19: Fidelity Help Command
```bash
persona fidelity --help
```
- [ ] Help text displays correctly
- [ ] Options documented

### Test 20: Basic Fidelity Check
```bash
persona fidelity /tmp/persona_test/personas.json
```
- [ ] Analyses persona structure
- [ ] Reports completeness
- [ ] Shows fidelity score

### Test 21: Fidelity with Constraints
```bash
# Create constraints file
cat > /tmp/constraints.yaml << 'EOF'
required_fields:
  - name
  - demographics.age
  - behaviours
  - goals
age_range: [25, 55]
min_behaviours: 3
min_goals: 2
EOF

persona fidelity /tmp/persona_test/personas.json --constraints /tmp/constraints.yaml
```
- [ ] Validates against constraints
- [ ] Reports violations
- [ ] Shows field-level compliance

### Test 22: Fidelity - Age Range
```bash
persona fidelity /tmp/persona_test/personas.json --age-range "25-40"
```
- [ ] Validates age constraints
- [ ] Flags out-of-range ages

### Test 23: Fidelity - Goal Count
```bash
persona fidelity /tmp/persona_test/personas.json --goal-count "3-5"
```
- [ ] Validates goal count
- [ ] Flags insufficient/excessive goals

### Test 24: Fidelity - Strict Mode
```bash
persona fidelity /tmp/persona_test/personas.json --strict
```
- [ ] Fails on any violation
- [ ] Non-zero exit code

### Test 25: Fidelity Report
```bash
persona fidelity /tmp/persona_test/personas.json --report /tmp/fidelity_report.md
```
- [ ] Report file created
- [ ] Contains compliance summary
- [ ] Contains recommendations

---

## F-123: Generation Audit Trail

### Test 26: Audit Help Commands
```bash
persona audit --help
persona audit list --help
persona audit show --help
persona audit export --help
```
- [ ] Help text displays correctly
- [ ] Commands documented

### Test 27: Audit Configuration
```bash
persona audit config
```
- [ ] Shows audit trail settings
- [ ] Shows storage location
- [ ] Shows retention policy

### Test 28: Generate with Audit Trail
```bash
# Generate a persona to create audit record
persona generate --from /tmp/persona_test/interview.txt --count 1 --provider ollama
```
- [ ] Persona generated
- [ ] Audit record created (check with `persona audit list`)

### Test 29: Audit List
```bash
persona audit list
persona audit list --limit 10
persona audit list --from "2024-01-01"
```
- [ ] Lists audit records
- [ ] Shows timestamps
- [ ] Shows generation metadata
- [ ] Filtering works

### Test 30: Audit Show
```bash
# Get record ID from list, then show details
persona audit show <record_id>
```
- [ ] Shows full audit record
- [ ] Shows input data hash
- [ ] Shows model used
- [ ] Shows parameters

### Test 31: Audit Verify
```bash
persona audit verify <record_id>
```
- [ ] Verifies record integrity
- [ ] Shows signature status
- [ ] Reports tampering if detected

### Test 32: Audit Export
```bash
persona audit export --output /tmp/audit_export.json
persona audit export --output /tmp/audit_export.csv --format csv
```
- [ ] Exports to JSON format
- [ ] Exports to CSV format
- [ ] Contains complete records

### Test 33: Audit Prune
```bash
# Test with dry-run first
persona audit prune --older-than 7d --dry-run
```
- [ ] Shows records that would be deleted
- [ ] Dry-run doesn't delete

---

## Integration Tests

### Test 34: Full Quality Pipeline
```bash
# Generate personas, then run full quality assessment
persona generate --from /tmp/persona_test/interview.txt --count 3 --provider ollama --output /tmp/generated

# Run all quality checks
persona bias check /tmp/generated/personas.json
persona diversity analyse /tmp/generated/personas.json
persona fidelity /tmp/generated/personas.json

# Check audit trail
persona audit list --limit 5
```
- [ ] Generation succeeds
- [ ] All quality checks run
- [ ] Audit trail captures generation

### Test 35: CI/CD Quality Gate
```bash
# Simulate CI quality gate
persona bias check /tmp/persona_test/personas.json --max-score 0.5 --output json > /tmp/bias_result.json
echo "Exit code: $?"

persona diversity analyse /tmp/persona_test/personas.json --min-ttr 0.3 --output json > /tmp/diversity_result.json
echo "Exit code: $?"
```
- [ ] Commands return appropriate exit codes
- [ ] JSON output can be parsed by CI tools

---

## Error Handling

### Test 36: Invalid Input File
```bash
persona bias check /nonexistent/file.json
```
- [ ] Clear error message
- [ ] No stack trace

### Test 37: Invalid Constraints File
```bash
persona fidelity /tmp/persona_test/personas.json --constraints /nonexistent/constraints.yaml
```
- [ ] Clear error message
- [ ] Suggests valid path

### Test 38: Missing Dependencies
```bash
# In environment without bias dependencies
persona bias check /tmp/persona_test/personas.json --methods embedding
```
- [ ] Clear error about missing sentence-transformers
- [ ] Suggests installation command

---

## Cleanup

```bash
rm -rf /tmp/persona_test
rm -f /tmp/bias_report.md /tmp/verify_report.md /tmp/fidelity_report.md
rm -f /tmp/audit_export.json /tmp/audit_export.csv
rm -f /tmp/constraints.yaml
rm -rf /tmp/generated
```

---

## Test Results Summary

| Test | Pass | Fail | Notes |
|------|------|------|-------|
| 1. Bias Help | | | |
| 2. Bias Lexicon | | | |
| 3. Bias JSON | | | |
| 4. Bias Categories | | | |
| 5. Bias Threshold | | | |
| 6. Bias Max Score | | | |
| 7. Bias Report | | | |
| 8. Bias Clean | | | |
| 9. Verify Help | | | |
| 10. Self-Consistency | | | |
| 11. Multi-Model | | | |
| 12. Verify Report | | | |
| 13. Verify Threshold | | | |
| 14. Diversity Help | | | |
| 15. Diversity Analysis | | | |
| 16. Diversity JSON | | | |
| 17. Diversity Fields | | | |
| 18. Diversity Threshold | | | |
| 19. Fidelity Help | | | |
| 20. Basic Fidelity | | | |
| 21. Fidelity Constraints | | | |
| 22. Fidelity Age | | | |
| 23. Fidelity Goals | | | |
| 24. Fidelity Strict | | | |
| 25. Fidelity Report | | | |
| 26. Audit Help | | | |
| 27. Audit Config | | | |
| 28. Generate Audit | | | |
| 29. Audit List | | | |
| 30. Audit Show | | | |
| 31. Audit Verify | | | |
| 32. Audit Export | | | |
| 33. Audit Prune | | | |
| 34. Full Pipeline | | | |
| 35. CI Gate | | | |
| 36. Invalid Input | | | |
| 37. Invalid Constraints | | | |
| 38. Missing Deps | | | |

**Tester:** _______________
**Date:** _______________
**Version:** v1.7.0
**Platform:** _______________
