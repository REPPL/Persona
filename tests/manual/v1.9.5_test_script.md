# Manual Test Script: v1.9.5 - Enhanced Experiment Management

## Prerequisites

### Environment Setup
- [ ] Python 3.12+ installed
- [ ] Virtual environment activated (`.venv/`)
- [ ] All dependencies installed (`pip install -e ".[all]"`)

### For Generation Tests
- [ ] At least one LLM provider configured
- [ ] API keys in `.env` file

---

## Test 1: Run History Tracking

**Purpose:** Verify generation runs are tracked in history.json.

### Test 1a: Create Experiment and Generate

```bash
# Create test experiment
persona experiment create history-test -d "Testing run history"

# Add test data
echo "A developer who prefers command-line tools" > experiments/history-test/data/profile.txt

# Generate personas
persona generate --from experiments/history-test/data/profile.txt \
    --experiment history-test \
    --count 2

# Check history.json was created
cat experiments/history-test/history.json
```

**Expected Results:**
- [ ] Generation completes successfully
- [ ] `history.json` file created in experiment directory
- [ ] Contains run_id, started_at, completed_at, status
- [ ] Contains provider, model, persona_count, tokens

### Test 1b: View Run History

```bash
# List runs
persona experiment runs history-test

# List with limit
persona experiment runs history-test --last 5

# JSON output
persona experiment runs history-test --json
```

**Expected Results:**
- [ ] Table shows run ID, date, provider, model, personas, tokens, status
- [ ] --last limits output
- [ ] --json produces valid JSON

### Test 1c: Filter Runs

```bash
# Generate another run
persona generate --from experiments/history-test/data/profile.txt \
    --experiment history-test \
    --count 1

# Filter by status
persona experiment runs history-test --status success

# Filter by provider (use your provider)
persona experiment runs history-test --provider anthropic
```

**Expected Results:**
- [ ] Filters work correctly
- [ ] Only matching runs displayed

---

## Test 2: Global Experiment Registry

**Purpose:** Verify experiments can be registered globally.

### Test 2a: Register External Experiment

```bash
# Create experiment in non-standard location
mkdir -p /tmp/external-experiment/data
mkdir -p /tmp/external-experiment/outputs
echo "name: external-test" > /tmp/external-experiment/config.yaml
echo "A marketing professional" > /tmp/external-experiment/data/profile.txt

# Register it
persona experiment register external-test /tmp/external-experiment
```

**Expected Results:**
- [ ] Registration successful
- [ ] Shows path confirmation

### Test 2b: List Registry

```bash
# View registry
persona experiment registry

# View with validation
persona experiment registry --validate

# JSON output
persona experiment registry --json
```

**Expected Results:**
- [ ] Shows registered experiments
- [ ] --validate checks if paths exist
- [ ] --json produces valid JSON

### Test 2c: Use Registered Experiment

```bash
# Generate using registered experiment name
persona generate --from /tmp/external-experiment/data/profile.txt \
    --experiment external-test \
    --count 1

# View runs
persona experiment runs external-test
```

**Expected Results:**
- [ ] Can use registered name
- [ ] Run tracked in external experiment's history.json

### Test 2d: Unregister Experiment

```bash
# Unregister
persona experiment unregister external-test

# Verify removed from registry
persona experiment registry
```

**Expected Results:**
- [ ] Unregistration successful
- [ ] Files NOT deleted (only registry entry removed)
- [ ] No longer in registry list

---

## Test 3: Registry Cleanup

**Purpose:** Verify cleanup removes invalid registrations.

```bash
# Register an experiment
mkdir -p /tmp/cleanup-test
persona experiment register cleanup-test /tmp/cleanup-test

# Delete the directory (simulate moved/deleted experiment)
rm -rf /tmp/cleanup-test

# Validate (should show error)
persona experiment registry --validate

# Cleanup
persona experiment registry --cleanup

# Verify cleaned
persona experiment registry
```

**Expected Results:**
- [ ] --validate shows invalid path error
- [ ] --cleanup removes invalid entry
- [ ] Entry no longer in registry

---

## Test 4: Duplicate Registration Prevention

**Purpose:** Verify force flag required for overwriting.

```bash
# Create two directories
mkdir -p /tmp/reg-test-1
mkdir -p /tmp/reg-test-2

# Register first
persona experiment register dup-test /tmp/reg-test-1

# Try to register same name (should fail)
persona experiment register dup-test /tmp/reg-test-2

# Force overwrite
persona experiment register dup-test /tmp/reg-test-2 --force

# Cleanup
persona experiment unregister dup-test
rm -rf /tmp/reg-test-1 /tmp/reg-test-2
```

**Expected Results:**
- [ ] Second registration fails without --force
- [ ] Error message suggests --force
- [ ] --force allows overwrite

---

## Test 5: Multiple Run Tracking

**Purpose:** Verify multiple runs are tracked correctly.

```bash
# Generate multiple times
persona generate --from experiments/history-test/data/profile.txt \
    --experiment history-test --count 1

persona generate --from experiments/history-test/data/profile.txt \
    --experiment history-test --count 2

persona generate --from experiments/history-test/data/profile.txt \
    --experiment history-test --count 3

# View all runs
persona experiment runs history-test

# Check totals
persona experiment runs history-test --json | python -c "
import json, sys
data = json.load(sys.stdin)
runs = data['data']['runs']
print(f'Total runs: {len(runs)}')
print(f'Total personas: {sum(r[\"persona_count\"] for r in runs)}')
"
```

**Expected Results:**
- [ ] All runs recorded
- [ ] Each run has unique ID
- [ ] Runs ordered by date (most recent first)

---

## Cleanup

```bash
# Delete test experiments
persona experiment delete history-test --force

# Remove temp files
rm -rf /tmp/external-experiment
rm -rf /tmp/cleanup-test
```

---

## Summary Checklist

| Test | Status |
|------|--------|
| Run history creation | [ ] |
| View run history | [ ] |
| Filter runs | [ ] |
| Register experiment | [ ] |
| List registry | [ ] |
| Use registered experiment | [ ] |
| Unregister experiment | [ ] |
| Registry cleanup | [ ] |
| Duplicate prevention | [ ] |
| Multiple run tracking | [ ] |

**Tester:** _______________
**Date:** _______________
**Version:** v1.9.5
