# v1.8.0 - Technical Debt & Refactoring

## Overview

| Attribute | Value |
|-----------|-------|
| **Theme** | Technical Debt & Refactoring |
| **Features** | 0 (refactoring only) |
| **Status** | Planned |
| **Dependencies** | v1.7.0 Research Compliance |

## Goals

Address accumulated technical debt, improve code quality, and prepare the codebase for future feature development. This release focuses exclusively on internal improvements with no user-facing feature changes.

**Theme:** "Foundation Strengthening" - Clean architecture for sustainable growth.

---

## Scope

This is a **refactoring-only release** with no feature specifications. All work items are internal improvements tracked in this milestone document rather than as separate feature files.

---

## MUST (Critical - Do First)

These items address deprecations and critical code quality issues.

### M1: Fix datetime.utcnow() Deprecation

**Location:** `src/persona/core/audit/logger.py` (lines 169, 255)
**Risk:** Will break in Python 3.13+
**Effort:** 30 minutes

```python
# Before
timestamp=datetime.utcnow()

# After
from datetime import datetime, timezone
timestamp=datetime.now(timezone.utc)
```

**Files affected:**
- `src/persona/core/audit/logger.py`
- `tests/unit/core/audit/test_json_store.py`
- `tests/unit/core/audit/test_sqlite_store.py`

- [ ] Replace deprecated datetime.utcnow() calls
- [ ] Update related test files
- [ ] Verify all tests pass

---

### M2: Replace Bare Exception Handlers

**Locations:** 9 instances across codebase
**Risk:** Swallows critical errors, makes debugging difficult
**Effort:** 4-6 hours

| File | Location | Current | Fix |
|------|----------|---------|-----|
| `ui/cli.py` | ~line 531 | `except Exception` | `except (ImportError, AttributeError)` |
| `quality/bias/detector.py` | 3 instances | `except Exception` | `except (FileNotFoundError, ValueError)` |
| `batch/tokens.py` | ~line 142 | `except Exception` | `except TokenEstimationError` + logging |
| `ui/interactive.py` | multiple | `except Exception` | Specific exceptions |
| `providers/rotation.py` | | `except Exception` | `except ProviderError` |

- [ ] Audit all bare exception handlers
- [ ] Replace with specific exception types
- [ ] Add appropriate logging where needed
- [ ] Verify error handling tests pass

---

### M3: Verify Test __init__.py Files Complete

**Risk:** Pytest collection errors in CI
**Effort:** 15 minutes
**Status:** Partially done in v1.7.0, verify completeness

- [ ] Run: `find tests -type d -exec test ! -f {}/__init__.py \; -print`
- [ ] Add missing `__init__.py` files
- [ ] Verify pytest collection succeeds

---

## SHOULD (Important - Plan for This Release)

These items improve maintainability and code quality.

### S1: Refactor Large Files (>750 lines)

**Impact:** Maintainability, testability, cognitive load
**Effort:** 2-3 days per file

| File | Lines | Problem | Solution |
|------|-------|---------|----------|
| `core/experiments/manager.py` | 1,158 | 4 responsibilities mixed | Extract: ExperimentRunner, ExperimentStorage, ExperimentAnalyser |
| `ui/interactive.py` | 944 | 30+ methods | Extract: PromptBuilder, InputValidator, OutputFormatter |
| `ui/commands/experiment.py` | 843 | Duplicate patterns | Extract shared logic to base class |
| `core/templates/manager.py` | 822 | 17 methods | Extract: TemplateLoader, TemplateValidator, TemplateRenderer |
| `core/clustering/cluster.py` | 772 | 19 methods | Extract: ClusteringAlgorithm (strategy pattern) |

**Recommended order:** experiments/manager.py -> interactive.py -> clustering/cluster.py

- [ ] Refactor experiments/manager.py
- [ ] Refactor interactive.py
- [ ] Refactor experiment.py command
- [ ] Refactor templates/manager.py
- [ ] Refactor cluster.py

---

### S2: Extract Quality Command Base Pattern

**Impact:** DRY, consistency, maintainability
**Effort:** 1-2 days

**Current duplication across:**
- `commands/academic.py`
- `commands/bias.py`
- `commands/diversity.py`
- `commands/faithfulness.py`
- `commands/fidelity.py`
- `commands/verify.py`

**Duplicated patterns:**
1. Persona loading from file/directory
2. Multi-format output (rich/json/markdown)
3. Colour-coded scoring display
4. Report generation
5. Threshold-based exit codes

**Solution:** Create `commands/quality_base.py`:

```python
class QualityCommandBase:
    def load_personas(self, path: Path) -> list[Persona]: ...
    def format_output(self, report, format: str) -> str: ...
    def colour_score(self, score: float) -> str: ...
    def generate_markdown_report(self, report) -> str: ...
    def check_threshold(self, score: float, max_score: float) -> None: ...
```

- [ ] Create QualityCommandBase class
- [ ] Refactor academic.py to use base
- [ ] Refactor bias.py to use base
- [ ] Refactor diversity.py to use base
- [ ] Refactor faithfulness.py to use base
- [ ] Refactor fidelity.py to use base
- [ ] Refactor verify.py to use base

---

### S3: Replace CLI Global State

**Location:** `src/persona/ui/cli.py` (lines 87-90)
**Impact:** Thread safety, testability
**Effort:** 4-8 hours

**Current (anti-pattern):**
```python
_no_color: bool = False
_quiet: bool = False
_verbosity: int = 1
_interactive: bool = False
```

**Solution:** Use Typer context or dataclass:

```python
@dataclass
class CLIContext:
    no_color: bool = False
    quiet: bool = False
    verbosity: int = 1
    interactive: bool = False

@app.callback()
def main(ctx: typer.Context, ...):
    ctx.obj = CLIContext(...)
```

- [ ] Create CLIContext dataclass
- [ ] Update main callback to use context
- [ ] Update all commands to read from context
- [ ] Update tests for new pattern

---

### S4: Add Missing Docstrings

**Impact:** API documentation, IDE support
**Effort:** 2-3 hours

**Priority files:**

| File | Missing | Type |
|------|---------|------|
| `core/errors.py` | 22 | Exception `__init__` methods |
| `core/data/formats.py` | 7 | FormatLoader properties |
| `core/providers/*.py` | 16 | Provider interface properties |

- [ ] Add docstrings to core/errors.py
- [ ] Add docstrings to core/data/formats.py
- [ ] Add docstrings to core/providers/

---

### S5: Refactor CLI Parameter Structures

**Impact:** Readability, maintainability
**Effort:** 8-12 hours

Commands with 10+ parameters are difficult to maintain.

**Solution:** Parameter dataclasses:

```python
@dataclass
class BiasCheckParams:
    categories: list[str] = field(default_factory=lambda: ["gender", "racial", "age"])
    methods: list[str] = field(default_factory=lambda: ["lexicon"])
    threshold: float = 0.3
    output_format: str = "rich"
```

- [ ] Identify commands with >8 parameters
- [ ] Create parameter dataclasses
- [ ] Refactor commands to use dataclasses
- [ ] Update tests

---

### S6: Lazy Load Heavy Dependencies

**Impact:** CLI startup time (currently 5-10+ seconds for simple commands)
**Effort:** 4-6 hours

**Problem:** Every CLI command imports torch, transformers, spacy, sentence-transformers at startup, even for `--version` or `--help`.

**Heavy imports to defer:**
- `torch` (~2-3s)
- `transformers` (~1-2s)
- `spacy` (~1s)
- `sentence_transformers` (~1s)
- `presidio_analyzer` / `presidio_anonymizer` (~0.5s)
- `bert_score` (~0.5s)

**Solution:** Lazy imports at point of use:

```python
# Before (in module top-level)
from transformers import AutoModel

# After (at point of use)
def analyse_text(...):
    from transformers import AutoModel
    model = AutoModel.from_pretrained(...)
```

**Files to refactor:**
- `core/quality/bias/detector.py`
- `core/quality/diversity/metrics.py`
- `core/quality/fidelity/scorer.py`
- `core/quality/verification/multi_model.py`
- `core/validation/academic.py`
- `core/validation/hallucination.py`
- `core/privacy/detector.py`
- `ui/commands/*.py` (quality commands)

- [ ] Identify all heavy imports at module level
- [ ] Move imports to function level where used
- [ ] Verify CLI startup time < 1 second for simple commands
- [ ] Add startup time test to prevent regression

---

## COULD (Nice-to-Have - Backlog for v1.8.x)

These items are lower priority and may be deferred to patch releases.

### C1: Add Integration Tests for Quality Workflows

**Impact:** Confidence in E2E functionality
**Effort:** 2-3 days

Missing integration tests:
- [ ] Multi-model verification E2E
- [ ] Bias detection with all methods
- [ ] Complete audit trail generation
- [ ] Quality validation pipelines
- [ ] Privacy detection workflows
- [ ] Clustering/consolidation workflows

---

### C2: Create Architecture Documentation

**Impact:** Onboarding, design decisions
**Effort:** 1-2 days

Missing documentation:
- [ ] Module interaction diagrams
- [ ] Layer architecture (UI -> Core -> Providers)
- [ ] Quality metrics implementation guide
- [ ] Plugin system tutorial

---

### C3: Consolidate Format Loading Patterns

**Impact:** Code reuse
**Effort:** 2-3 hours

Multiple files implement similar format detection:
- `core/data/formats.py`
- `core/data/loader.py`
- Various command files

- [ ] Create unified format detection utility
- [ ] Refactor existing code to use it

---

### C4: Migrate Pydantic to ConfigDict

**Impact:** Eliminate deprecation warnings
**Effort:** 2-3 hours

Files with deprecated class-based Config:
- `api/config.py`
- `api/models/requests.py`
- `core/audit/models.py`

```python
# Before
class Config:
    extra = "forbid"

# After
model_config = ConfigDict(extra="forbid")
```

- [ ] Update api/config.py
- [ ] Update api/models/requests.py
- [ ] Update core/audit/models.py

---

### C5: Extract Clustering Algorithms (Strategy Pattern)

**Location:** `core/clustering/cluster.py`
**Impact:** Extensibility, testability
**Effort:** 4-6 hours

**Proposed structure:**
```python
class ClusteringStrategy(ABC):
    @abstractmethod
    def cluster(self, data: np.ndarray, n_clusters: int) -> np.ndarray: ...

class KMeansStrategy(ClusteringStrategy): ...
class HierarchicalStrategy(ClusteringStrategy): ...
class DBSCANStrategy(ClusteringStrategy): ...
```

- [ ] Define ClusteringStrategy ABC
- [ ] Extract KMeansStrategy
- [ ] Extract HierarchicalStrategy
- [ ] Extract DBSCANStrategy
- [ ] Update cluster.py to use strategies

---

## Success Criteria

- [ ] All MUST items completed
- [ ] At least 3 of 5 SHOULD items completed
- [ ] No new deprecation warnings
- [ ] Test coverage maintained at >= 85%
- [ ] Pre-commit hooks pass
- [ ] No bare exception handlers in critical paths

---

## Non-Goals

- No new user-facing features
- No new CLI commands
- No API changes
- No new dependencies (unless replacing deprecated ones)

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Refactoring introduces bugs | Medium | Medium | Comprehensive test coverage |
| Scope creep | Medium | Medium | Strict MUST/SHOULD/COULD priority |
| Breaking changes | Low | High | No public API changes |

---

## Related Documentation

- [Roadmap Dashboard](../README.md)
- [v1.7.0: Research Compliance](v1.7.0.md)
- [v1.9.0: Experiment Infrastructure](v1.9.0.md)

---

**Status**: Planned
