# Milestone: v1.5.0 - Hybrid Pipeline

Cost-optimised persona generation combining local and frontier models.

## Goal

Provide a hybrid generation pipeline that achieves near-frontier quality at significantly reduced cost by using local models for draft generation and quality filtering, with optional frontier model refinement.

## Theme

**"Best of Both Worlds"** - Optimal quality/cost trade-off.

## Features (1 of 1 Complete)

| ID | Feature | Category | Status |
|----|---------|----------|--------|
| [F-116](../features/completed/F-116-hybrid-local-frontier-pipeline.md) | Hybrid Local/Frontier Pipeline | Optimisation | ✅ Complete |

## Success Criteria

- [ ] `persona generate --hybrid` produces frontier-quality personas
- [ ] 50%+ cost reduction vs frontier-only for bulk generation
- [ ] Quality within 5% of frontier-only approach (measurable)
- [ ] Budget constraints respected (`--max-cost`)
- [ ] Privacy mode works (local-only with `--no-frontier`)
- [ ] Cost estimation before generation
- [ ] Test coverage >= 90%

## Use Cases Addressed

| Use Case | How Addressed |
|----------|---------------|
| Budget-conscious teams | Significant cost reduction |
| High-volume generation | Scalable with budget caps |
| Privacy + quality | Local drafts, optional refinement |
| Quality assurance | Multi-stage filtering |

## Cost Comparison

| Approach | 10 Personas | 100 Personas | Quality |
|----------|-------------|--------------|---------|
| Frontier Only | $2.00 | $20.00 | 95% |
| Hybrid (2x drafts) | $1.00 | $10.00 | 93% |
| Hybrid (3x, 0.85 threshold) | $0.60 | $6.00 | 91% |
| Local Only (70B) | $0.00 | $0.00 | 88% |

## Pipeline Architecture

```
Input Data → PII Anonymisation → Local Draft Generation → Local Quality Filter
                                         ↓                        ↓
                                    N×2 Drafts              Top N Candidates
                                                                  ↓
                                                    [Optional] Frontier Refinement
                                                                  ↓
                                                          Final Personas
```

## Installation

```bash
# Generate with hybrid pipeline
persona generate --input research.csv --hybrid

# Budget-constrained
persona generate --input research.csv --hybrid --max-cost 5.00

# Privacy mode (local only)
persona generate --input sensitive.csv --hybrid --no-frontier

# Cost estimation
persona generate --input research.csv --hybrid --estimate-only
```

## Dependencies

- v1.4.0: Quality & Data Generation (evaluation, synthetic data)
- F-112: Native Ollama Provider
- F-113: PII Detection & Anonymisation (optional)
- F-114: LLM-as-Judge Persona Evaluation

## Non-Goals

- Automatic provider selection (user specifies frontier provider)
- Real-time cost optimisation (pre-configured thresholds)
- Custom refinement prompts (use built-in templates)

## Technical Considerations

### Configuration Options

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `draft_multiplier` | int | 2 | Drafts per final persona |
| `quality_threshold` | float | 0.75 | Minimum quality for refinement |
| `use_frontier` | bool | True | Enable frontier refinement |
| `max_frontier_cost` | float | None | Budget cap (USD) |

### Pipeline Stages

1. **Data Preparation** - Load input, optionally anonymise PII
2. **Local Draft Generation** - Generate N×multiplier candidates
3. **Quality Filtering** - Local LLM-as-judge scoring
4. **Frontier Refinement** - Polish top candidates (optional)
5. **Final Output** - Cost report, quality metrics

## Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| Quality degradation | Configurable threshold, conservative defaults |
| Unexpected costs | Budget cap, cost estimation before run |
| Local model unavailable | Fall back to frontier-only with warning |
| Slow pipeline | Progress feedback, parallel local generation |

---

## Related Documentation

- [Milestones Overview](README.md)
- [v1.4.0: Quality & Data Generation](v1.4.0.md) (prerequisite)
- [F-116: Hybrid Local/Frontier Pipeline](../features/completed/F-116-hybrid-local-frontier-pipeline.md)
- [R-013: Local Model Assessment](../../research/R-013-local-model-assessment.md)

---

**Status**: Complete
