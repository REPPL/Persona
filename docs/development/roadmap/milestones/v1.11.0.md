# v1.11.0 - Code Quality & Architecture

**Theme:** Comprehensive refactoring and architectural improvements

**Dependencies:** v1.10.0 (Remote Data & Automation)

**Feature Count:** 8 (refactoring features)

---

## Goal

Address technical debt, reduce code duplication, improve type safety, and establish consistent architectural patterns across the codebase. This milestone focuses on internal quality improvements that enhance maintainability, testability, and performance without changing external APIs.

---

## Features

| ID | Feature | Priority | Category |
|----|---------|----------|----------|
| F-128 | JSON Parsing Utility Consolidation | High | Refactoring |
| F-129 | Provider HTTP Connection Pooling | High | Performance |
| F-130 | Hybrid Pipeline Stage Abstraction | High | Architecture |
| F-131 | TypedDict for Persona Structures | Medium | Type Safety |
| F-132 | Event Loop Management Standardisation | Medium | Async |
| F-133 | Quality Metric Registry Integration | Medium | Architecture |
| F-134 | Hybrid Stage Unit Tests | High | Testing |
| F-135 | Deprecated asyncio API Migration | Low | Maintenance |

---

## Implementation Plan

### Phase 1: Critical Fixes (High Priority)

#### F-128: JSON Parsing Utility Consolidation

**Problem:** Three independent implementations of JSON extraction from LLM responses exist across:
- `src/persona/core/generation/parser.py` (lines 180-219)
- `src/persona/core/hybrid/stages/draft.py` (lines 141-216)
- `src/persona/core/hybrid/stages/refine.py` (lines 167-230)

**Solution:** Create unified `src/persona/core/utils/json_extractor.py`:

```python
class JSONExtractor:
    """Unified JSON extraction from LLM responses."""

    @staticmethod
    def extract_json_from_text(text: str) -> dict[str, Any] | list[Any]:
        """Extract JSON from text with markdown code blocks."""
        ...

    @staticmethod
    def extract_json_array(content: str) -> list[dict[str, Any]]:
        """Extract JSON array with fallback handling."""
        ...

    @staticmethod
    def strip_markdown_code_blocks(text: str) -> str:
        """Remove markdown code block markers."""
        ...
```

**Tasks:**
- [x] Create `src/persona/core/utils/__init__.py`
- [x] Create `src/persona/core/utils/json_extractor.py`
- [x] Add comprehensive tests in `tests/unit/core/utils/test_json_extractor.py`
- [x] Refactor `parser.py` to use JSONExtractor
- [x] Refactor `draft.py` to use JSONExtractor
- [x] Refactor `refine.py` to use JSONExtractor
- [x] Verify all existing tests pass

**Lines Saved:** ~200 lines of duplicated code

---

#### F-129: Provider HTTP Connection Pooling

**Problem:** Each API call creates new `httpx.Client()`, wasting resources and adding latency.

**Affected Files:**
- `src/persona/core/providers/anthropic.py`
- `src/persona/core/providers/openai.py`
- `src/persona/core/providers/gemini.py`

**Solution:** Create base HTTP provider with connection pooling:

```python
class HTTPProvider(LLMProvider):
    """Base provider with connection pooling."""

    _client: httpx.AsyncClient | None = None

    @property
    async def client(self) -> httpx.AsyncClient:
        if not self._client:
            self._client = httpx.AsyncClient(
                timeout=httpx.Timeout(120.0),
                limits=httpx.Limits(max_connections=10),
            )
        return self._client

    async def cleanup(self) -> None:
        if self._client:
            await self._client.aclose()
            self._client = None
```

**Tasks:**
- [x] Create `src/persona/core/providers/http_base.py`
- [x] Add connection pool configuration options
- [x] Refactor AnthropicProvider to inherit HTTPProvider
- [x] Refactor OpenAIProvider to inherit HTTPProvider
- [x] Refactor GeminiProvider to inherit HTTPProvider
- [x] Add cleanup lifecycle to ProviderFactory
- [x] Add connection pooling tests
- [x] Benchmark before/after performance

---

#### F-130: Hybrid Pipeline Stage Abstraction

**Problem:** Three-stage pipeline hardcoded with different APIs, tight coupling, no reordering.

**Solution:** Create abstract `PipelineStage` base class:

```python
from abc import ABC, abstractmethod

class PipelineStage(ABC):
    """Abstract base for hybrid pipeline stages."""

    @property
    @abstractmethod
    def name(self) -> str:
        """Stage name for logging."""
        ...

    @abstractmethod
    async def execute(
        self,
        input_data: StageInput,
        context: PipelineContext,
    ) -> StageOutput:
        """Execute stage with unified API."""
        ...

class DraftStage(PipelineStage):
    """Generate initial persona drafts."""
    ...

class FilterStage(PipelineStage):
    """Filter personas based on quality threshold."""
    ...

class RefineStage(PipelineStage):
    """Refine personas that need improvement."""
    ...
```

**Tasks:**
- [x] Create `src/persona/core/hybrid/stages/base.py` with PipelineStage
- [x] Define `StageInput` and `StageOutput` dataclasses
- [x] Define `PipelineContext` for shared state
- [x] Refactor DraftStage to inherit PipelineStage
- [x] Refactor FilterStage to inherit PipelineStage
- [x] Refactor RefineStage to inherit PipelineStage
- [x] Update HybridPipeline to use stage composition
- [x] Add stage reordering/skip configuration

---

#### F-134: Hybrid Stage Unit Tests

**Problem:** Hybrid stages tested indirectly through integration tests only.

**Solution:** Create dedicated unit tests for each stage:

**Tasks:**
- [x] Create `tests/unit/core/hybrid/stages/__init__.py`
- [x] Create `tests/unit/core/hybrid/stages/test_draft.py`
- [x] Create `tests/unit/core/hybrid/stages/test_filter.py`
- [x] Create `tests/unit/core/hybrid/stages/test_refine.py`
- [x] Mock ProviderFactory, CostTracker, PersonaJudge
- [x] Test error handling scenarios
- [x] Test batch processing edge cases
- [x] Achieve 85%+ coverage on stages

---

### Phase 2: Type Safety (Medium Priority)

#### F-131: TypedDict for Persona Structures

**Problem:** Extensive use of `dict[str, Any]` reduces type safety.

**Solution:** Create typed dictionaries for persona data:

```python
from typing import TypedDict, NotRequired

class PersonaDict(TypedDict):
    """Typed dictionary for persona data."""
    name: str
    age: NotRequired[int]
    occupation: NotRequired[str]
    background: str
    goals: list[str]
    frustrations: list[str]
    behaviours: list[str]
    motivations: list[str]
    # ... other fields

class RefinedPersonaDict(PersonaDict):
    """Persona with refinement metadata."""
    refinement_notes: NotRequired[str]
    quality_score: NotRequired[float]
```

**Tasks:**
- [x] Create `src/persona/core/types/persona.py`
- [x] Define PersonaDict with all persona fields
- [x] Define RefinedPersonaDict for pipeline output
- [x] Define DraftPersonaDict for intermediate stages
- [x] Update hybrid stages to use typed dicts
- [x] Update generation pipeline to use typed dicts
- [x] Add type checking to CI

---

#### F-132: Event Loop Management Standardisation

**Problem:** Inconsistent async/sync patterns across modules, deprecated API usage.

**Files Affected:**
- `src/persona/core/generation/pipeline.py` (lines 231-304)
- `src/persona/core/hybrid/pipeline.py` (lines 216-247)

**Solution:** Standardise on async-first with proper sync wrappers:

```python
def generate_sync(self, *args, **kwargs) -> list[Persona]:
    """Synchronous wrapper for async generation."""
    try:
        loop = asyncio.get_running_loop()
        raise RuntimeError(
            "Cannot call generate_sync() from async context. "
            "Use await generate() instead."
        )
    except RuntimeError:
        return asyncio.run(self.generate(*args, **kwargs))
```

**Tasks:**
- [x] Audit all sync/async wrapper implementations
- [x] Create `src/persona/core/utils/async_helpers.py`
- [x] Implement `run_sync()` utility with proper detection
- [x] Fix bug in HybridPipeline.generate_sync() (returns Task, not result)
- [x] Update all pipelines to use consistent pattern
- [x] Document async usage patterns
- [x] Replace deprecated `asyncio.get_event_loop()` calls

---

#### F-133: Quality Metric Registry Integration

**Problem:** QualityScorer hard-codes metric instantiation, can't use existing registry.

**File:** `src/persona/core/quality/scorer.py`

**Solution:** Use registry pattern for metrics:

```python
class QualityScorer:
    def __init__(
        self,
        config: QualityConfig,
        registry: MetricRegistry | None = None,
    ) -> None:
        self.config = config
        self.registry = registry or MetricRegistry.default()
        self._metrics = self.registry.get_all_metrics(config)
```

**Tasks:**
- [x] Update MetricRegistry with get_all_metrics() method
- [x] Modify QualityScorer to accept registry parameter
- [x] Remove hard-coded metric instantiation
- [x] Add metric discovery via registry
- [x] Enable custom metric registration
- [x] Update tests for new pattern

---

### Phase 3: Maintenance (Low Priority)

#### F-135: Deprecated asyncio API Migration

**Problem:** `asyncio.get_event_loop()` deprecated in Python 3.10+.

**Affected Files:**
- `src/persona/core/async_utils.py` (line 134)
- `src/persona/core/providers/base.py` (line 134)

**Solution:** Replace with `asyncio.get_running_loop()` or `asyncio.new_event_loop()`.

**Tasks:**
- [x] Find all deprecated asyncio calls
- [x] Replace with modern equivalents
- [x] Test on Python 3.12+
- [x] Update minimum Python version if needed

---

## Success Criteria

### Code Quality
- [x] Zero code duplication in JSON parsing
- [x] All providers use connection pooling
- [x] Hybrid stages follow consistent interface
- [x] Type hints use TypedDict instead of dict[str, Any]

### Testing
- [x] Hybrid stage unit test coverage ≥ 85%
- [x] All new utilities have comprehensive tests
- [x] No regression in existing test suite

### Performance
- [x] Connection pooling reduces API call latency by ≥ 20%
- [x] Memory usage stable during batch operations

### Documentation
- [x] All new utilities documented with docstrings
- [x] Async patterns documented in developer guide
- [x] Architecture changes documented in ADR

---

## Non-Goals

- External API changes (backwards compatible only)
- New user-facing features
- Changes to CLI interface
- Database schema changes

---

## Dependencies

- v1.10.0 must be complete (current active features)
- Python 3.12+ compatibility required

---

## Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Regression in existing functionality | Medium | High | Comprehensive test suite, staged rollout |
| Breaking async/sync compatibility | Low | High | Maintain existing public APIs |
| Performance regression from abstraction | Low | Medium | Benchmark before/after |

---

## Related Documentation

- [Features Index](../features/)
- [v1.10.0 Milestone](v1.10.0.md)
- [Architecture Decisions](../../decisions/adrs/)

---

**Status**: Complete
