# DevLog: v0.4.0 - Advanced Output + Conversation Scripts

## Implementation Narrative

v0.4.0 represents a significant evolution of Persona's output capabilities, moving beyond basic JSON/Markdown to sophisticated narrative, table, and privacy-audited conversation script generation.

The implementation began with F-039 (formatter registry), establishing a plugin architecture using Python decorators. This foundation pattern proved crucial - every subsequent formatter could be registered with a simple `@register` decorator, making the system highly extensible.

The output formatters (F-036 narrative, F-037 tables, F-038 usage scenarios) followed naturally, each building on the registry infrastructure. The narrative formatter introduced perspective switching (first vs third person), while the table formatters provided four distinct output formats (ASCII, Markdown, CSV, LaTeX) for persona comparison.

The most complex feature was F-086 (conversation scripts). This required a multi-stage abstraction pipeline to transform raw persona data into privacy-safe character cards suitable for LLM roleplay. The key insight was that privacy protection must be architectural, not procedural - the system simply cannot output scripts that fail privacy audit.

## Challenges Encountered

- **Privacy leakage detection**: Initial attempts at simple string matching caught too many false positives. The solution was a multi-layered approach: direct quote matching, 3-word phrase detection, significant word overlap calculation, and identifier pattern matching. Each check has its own severity weight.

- **Abstraction granularity**: Finding the right level of abstraction for character cards required iteration. Too abstract and the character loses distinctiveness; too specific and source data leaks. The final design uses categorical abstraction ("frustrated by manual processes" instead of specific quotes about manual processes).

- **Knowledge boundaries**: Defining what a synthetic character "knows" vs "doesn't know" vs "can infer" required careful thought about how personas contain implicit knowledge derived from their demographics and behaviours.

## Code Highlights

### Privacy Audit Architecture

```python
def audit(self, card: CharacterCard, source_persona: Persona) -> PrivacyAuditResult:
    leakages: list[LeakageInstance] = []

    if self._config.check_direct_quotes:
        leakages.extend(self._check_direct_quotes(content, source_quotes))
    if self._config.check_paraphrases:
        leakages.extend(self._check_paraphrases(content, source_quotes))
    # ... additional checks

    leakage_score = self._calculate_leakage_score(leakages)
    passed = leakage_score <= self._config.max_leakage_score
```

The audit is mandatory - ConversationScriptGenerator blocks output if `audit_result.blocked and self._block_on_failure`.

### Abstractor Pipeline

```python
# Abstractors transform raw data to privacy-safe patterns
quote_result = self._quote_abstractor.abstract(persona.quotes)
# Returns AbstractionResult with abstracted_content (patterns, not quotes)

scenario_result = self._scenario_generaliser.abstract(scenarios)
# Returns generalised scenarios without specific details

behaviour_result = self._behaviour_abstractor.abstract(persona.behaviours)
# Returns tendency patterns derived from behaviours
```

### Registry Decorator Pattern

```python
@register(name="narrative", description="Narrative text formatter", extension=".md")
class RegisteredNarrativeFormatter(NarrativeFormatter):
    """Auto-registered formatter via decorator."""
    pass
```

## Dependencies Added

No new dependencies - all features built on existing stack (Jinja2, Pydantic, dataclasses).

## Files Created

### Source Files (12)
- `src/persona/core/output/registry.py` - Formatter registry with plugin system
- `src/persona/core/output/narrative.py` - First/third person narrative formatters
- `src/persona/core/output/tables.py` - ASCII, Markdown, CSV, LaTeX table formatters
- `src/persona/core/output/usage.py` - Usage scenario and journey generation
- `src/persona/core/output/readme.py` - Automatic README generation
- `src/persona/core/output/response_capture.py` - LLM response capture and storage
- `src/persona/core/scripts/__init__.py` - Scripts module initialisation
- `src/persona/core/scripts/models.py` - CharacterCard and component models
- `src/persona/core/scripts/abstractors.py` - Privacy-preserving abstraction classes
- `src/persona/core/scripts/privacy.py` - Privacy auditor with leakage detection
- `src/persona/core/scripts/generator.py` - Conversation script generator
- `src/persona/core/scripts/formatters.py` - Script output formatters

### Test Files (7)
- `tests/unit/core/test_registry.py` (36 tests)
- `tests/unit/core/test_narrative.py` (41 tests)
- `tests/unit/core/test_tables.py` (52 tests)
- `tests/unit/core/test_usage.py` (39 tests)
- `tests/unit/core/test_readme.py` (37 tests)
- `tests/unit/core/test_response_capture.py` (39 tests)
- `tests/unit/core/test_scripts.py` (64 tests)

## Test Metrics

- **Tests before**: 653
- **Tests after**: 961
- **Tests added**: 308
- **All passing**: Yes

---

## Related Documentation

- [v0.4.0 Milestone](../../roadmap/milestones/v0.4.0.md)
- [v0.4.0 Retrospective](../retrospectives/v0.4.0-retrospective.md)
- [Manual Test Script](../../../../tests/manual/v0.4.0_test_script.md)

---

**Status**: Complete
