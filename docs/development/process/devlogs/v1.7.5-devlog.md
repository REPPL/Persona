# DevLog: v1.7.5 - Project Organisation System

## Implementation Narrative

v1.7.5 introduces a registry-based project management system inspired by the eval project. This enables users to reference projects by name from anywhere on the filesystem, with support for both XDG Base Directory Specification and legacy ~/.persona/ locations.

### Session 1: Research and Planning

Extensive analysis of the eval project's registry system led to a comprehensive implementation plan:

**Key patterns identified:**
- Central config file mapping project names to filesystem paths
- Three-level configuration cascade (global → project → runtime)
- Template system for different project types
- Hierarchical output organisation with manifests

**Design decisions:**
- Support both XDG_CONFIG_HOME and ~/.persona/ for cross-platform compatibility
- Two templates: basic (minimal) and research (comprehensive)
- Legacy persona.yaml format support for backwards compatibility

### Session 2: Core Module Implementation

```
src/persona/core/project/
├── __init__.py      # Module exports
├── models.py        # Pydantic models (DataSource, ProjectMetadata, ProjectRegistry)
├── registry.py      # RegistryManager for project registration
├── context.py       # ProjectContext for reference resolution
└── manager.py       # ProjectManager for CRUD operations
```

**Models implemented:**
- `ProjectMetadata`: Rich metadata with timestamps, templates, data sources
- `ProjectRegistry`: Central registry with global defaults
- `DataSource`: Named data references with type information
- `GlobalDefaults`: Provider, model, and count settings

**Registry features:**
- XDG_CONFIG_HOME support (Linux standard)
- Legacy ~/.persona/ fallback (macOS/Windows)
- YAML serialisation with helpful comments
- Persistence across CLI invocations

### Session 3: CLI Commands

```bash
# Project management
persona project list              # List registered projects
persona project create <name>     # Create and register new project
persona project register <path>   # Register existing project
persona project unregister <name> # Remove from registry
persona project show <name>       # Show project details
persona project add-source        # Add data source to project
persona project defaults          # Show/set global defaults
```

**Integration:**
- Added to essential commands (visible by default)
- Consistent with existing command patterns
- Rich output with tables and status indicators

### Session 4: Project Templates

**basic template:**
```
project-name/
├── project.yaml    # Project configuration
├── data/           # Input data files
│   └── README.md
├── output/         # Generated personas
│   └── manifest.json
└── README.md
```

**research template:**
```
project-name/
├── project.yaml
├── data/
│   ├── raw/        # Original data
│   ├── processed/  # Transformed data
│   └── README.md
├── config/
│   ├── prompts/    # Template overrides
│   └── models/     # Per-model configs
├── output/
│   ├── personas/
│   ├── exports/
│   └── manifest.json
├── templates/      # Custom Jinja templates
└── README.md
```

### Testing Strategy

59 unit tests cover the new project module:

| Module | Tests | Coverage |
|--------|-------|----------|
| models.py | 20 | ~90% |
| registry.py | 20 | ~85% |
| manager.py | 19 | ~85% |

Tests verify:
- Model validation and serialisation
- Registry persistence and path resolution
- Project creation with both templates
- Data source management
- Legacy format compatibility

---

## Files Created

### Core Implementation
- `src/persona/core/project/__init__.py`
- `src/persona/core/project/models.py`
- `src/persona/core/project/registry.py`
- `src/persona/core/project/context.py`
- `src/persona/core/project/manager.py`

### CLI Commands
- `src/persona/ui/commands/project.py`

### Tests
- `tests/unit/core/project/__init__.py`
- `tests/unit/core/project/test_models.py`
- `tests/unit/core/project/test_registry.py`
- `tests/unit/core/project/test_manager.py`

---

## Technical Decisions

### XDG Support

```python
def get_registry_path() -> Path:
    # Check XDG location first (Linux standard)
    xdg_path = get_xdg_config_home() / "persona" / "config.yaml"
    if xdg_path.exists():
        return xdg_path

    # Fall back to legacy location (macOS/Windows)
    legacy_path = Path.home() / ".persona" / "config.yaml"
    if legacy_path.exists():
        return legacy_path

    # Default based on platform
    if sys.platform.startswith("linux"):
        return xdg_path
    return legacy_path
```

### Legacy Format Support

```python
@classmethod
def from_yaml_dict(cls, data: dict) -> "ProjectMetadata":
    # Handle legacy format (project: name: xxx)
    if "project" in data and "name" in data["project"]:
        legacy = data["project"]
        new_data = {"name": legacy.get("name"), ...}
    return cls.model_validate(data)
```

---

## Related Documentation

- [v1.7.5 Retrospective](../retrospectives/v1.7.5-retrospective.md)
- [Project Organisation Research](../../research/project-organisation.md)
- [DevLogs Index](README.md)

---

**Status**: Ready for release
