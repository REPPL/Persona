# DevLog: v1.9.0 - Experiment Infrastructure

## Implementation Narrative

v1.9.0 delivers foundational research infrastructure with two major features: a comprehensive experiment management system (F-124) and W3C PROV-compliant data lineage tracking (F-125). Together, these features enable reproducible research workflows with complete provenance tracking.

### Feature Overview

| Feature | Purpose | Key Capability |
|---------|---------|----------------|
| F-124: Experiment Management | Organise and compare research | Projects, variants, parameter tracking |
| F-125: Data Lineage | Track data provenance | W3C PROV model, hash verification |

---

## Session 1: Experiment Management System (F-124)

### Architecture

The experiment management system introduces a three-tier hierarchy:

```
Project (top level)
└── Experiment (named research effort)
    └── Variant (parameter configuration)
        └── Run (single execution)
```

**Core components:**

```
core/experiments/
├── models.py         # Project, Experiment, Variant, Run dataclasses
├── manager.py        # ExperimentManager orchestrator
├── sqlite_store.py   # SQLite persistence layer
└── __init__.py       # Public API exports

ui/commands/
├── project.py        # Project management CLI
└── variant.py        # Variant management CLI
```

### SQLite Storage

Chose SQLite for experiment storage to balance simplicity with query capability:

```python
class ExperimentSQLiteStore:
    """SQLite-backed experiment storage with full CRUD operations."""

    def __init__(self, db_path: Path):
        self.db_path = db_path
        self._init_schema()

    def _init_schema(self) -> None:
        """Create tables for projects, experiments, variants, and runs."""
        # Projects table
        # Experiments table with project_id FK
        # Variants table with experiment_id FK
        # Runs table with variant_id FK
```

**Schema design:**
- Foreign key relationships maintain referential integrity
- JSON columns for flexible parameter storage
- Timestamps for audit purposes
- SHA-256 hashes for integrity verification

### Variant Management

Variants allow comparing different parameter configurations within the same experiment:

```bash
# Create variants with different parameters
persona variant create my-experiment high-temp --param temperature=0.9
persona variant create my-experiment low-temp --param temperature=0.3

# Compare variants
persona variant compare my-experiment high-temp low-temp
```

**Variant comparison output:**
```
Parameter Comparison: high-temp vs low-temp
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Parameter       high-temp    low-temp
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
temperature     0.9          0.3
top_p           0.95         0.95
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Differences: 1
```

### Project Registry

Global project registry enables working with projects by name:

```bash
# Register existing project
persona project register my-research ./path/to/project

# List all projects
persona project list

# Work with project by name
persona generate --project my-research --from data/
```

---

## Session 2: Data Lineage & Provenance (F-125)

### W3C PROV Data Model

Implemented the W3C PROV data model for provenance tracking:

```
┌─────────────┐     used      ┌─────────────┐
│   Entity    │◄─────────────│  Activity   │
│  (data)     │              │(transform)   │
└─────────────┘              └─────────────┘
      │                            │
      │ wasAttributedTo            │ wasAssociatedWith
      ▼                            ▼
┌─────────────┐              ┌─────────────┐
│   Agent     │              │    Agent    │
│  (creator)  │              │   (LLM)     │
└─────────────┘              └─────────────┘
```

**Core components:**

```
core/lineage/
├── models.py         # Entity, Activity, Agent, Relation dataclasses
├── hashing.py        # SHA-256 content hashing utilities
├── store.py          # Abstract LineageStore interface
├── sqlite_store.py   # SQLite implementation with graph traversal
└── __init__.py       # Public API exports

ui/commands/
└── lineage.py        # Lineage CLI commands
```

### Entity Types

```python
class EntityType(str, Enum):
    """Types of trackable entities."""
    INPUT_FILE = "input_file"
    PERSONA = "persona"
    PROMPT = "prompt"
    CONFIGURATION = "configuration"
    INTERMEDIATE = "intermediate"
```

### Content Hashing

Every entity gets a SHA-256 hash for integrity verification:

```python
def hash_content(content: str | bytes) -> str:
    """Generate SHA-256 hash of content."""
    if isinstance(content, str):
        content = content.encode("utf-8")
    return f"sha256:{hashlib.sha256(content).hexdigest()}"

def verify_hash(content: str | bytes, expected_hash: str) -> bool:
    """Verify content matches expected hash."""
    actual = hash_content(content)
    return actual == expected_hash
```

### Graph Traversal

The lineage store supports full graph traversal for provenance queries:

```python
def get_ancestors(self, entity_id: str, max_depth: int | None = None) -> LineageGraph:
    """Get all ancestors of an entity (what it was derived from)."""

def get_descendants(self, entity_id: str, max_depth: int | None = None) -> LineageGraph:
    """Get all descendants of an entity (what was derived from it)."""

def get_full_lineage(self, entity_id: str) -> LineageGraph:
    """Get complete lineage graph (ancestors + descendants)."""
```

### CLI Commands

```bash
# List tracked entities
persona lineage list --type persona

# Show entity details
persona lineage show ent-abc123

# Trace lineage (what inputs created this persona?)
persona lineage trace ent-abc123 --direction up

# Verify integrity (has the file been modified?)
persona lineage verify ent-abc123 --chain

# Export as PROV-JSON
persona lineage export --output lineage.json
```

### PROV-JSON Export

Lineage data exports to W3C PROV-JSON format:

```json
{
  "prefix": {
    "persona": "http://persona-cli.dev/ns#",
    "prov": "http://www.w3.org/ns/prov#"
  },
  "entity": {
    "persona:ent-abc123": {
      "prov:type": "persona:persona",
      "persona:hash": "sha256:abcd...",
      "prov:generatedAtTime": "2024-12-17T10:30:00Z"
    }
  },
  "activity": {
    "persona:act-xyz789": {
      "prov:type": "persona:llm_generation",
      "prov:startTime": "2024-12-17T10:29:55Z",
      "prov:endTime": "2024-12-17T10:30:00Z"
    }
  },
  "wasGeneratedBy": {
    "_:wgb1": {
      "prov:entity": "persona:ent-abc123",
      "prov:activity": "persona:act-xyz789"
    }
  }
}
```

---

## Testing Strategy

### F-124 Tests

```
tests/unit/experiments/
├── test_models.py           # Dataclass validation
├── test_sqlite_store.py     # CRUD operations, FK constraints
└── test_manager.py          # High-level operations
```

### F-125 Tests

```
tests/unit/lineage/
├── test_hashing.py          # Hash generation, verification
├── test_models.py           # Entity, Activity, Agent models
├── test_sqlite_store.py     # Graph traversal, relations
└── test_store.py            # Abstract interface contracts
```

**Test coverage:**
- F-124: 29 tests, ~85% coverage
- F-125: 54 tests, ~87% coverage

---

## Challenges & Solutions

### Challenge 1: SQL Injection False Positive

Bandit flagged dynamic SQL in the SQLite store:

```python
# Flagged as B608 (SQL injection)
query = f"UPDATE lineage_entities SET {set_clause} WHERE entity_id = ?"
```

**Solution:** Added `# nosec B608` with explanatory comment. The column names come from internal code, not user input. Parameter values are properly parameterised.

### Challenge 2: Graph Cycles

Lineage graphs could theoretically contain cycles (entity A derived from B derived from A).

**Solution:** Implemented depth limiting and visited-set tracking in traversal algorithms to prevent infinite loops.

### Challenge 3: Large Lineage Graphs

Complex workflows could produce very large lineage graphs.

**Solution:** Added pagination to list commands and depth limits to traversal queries. Export handles full graphs but warns on large datasets.

---

## Architecture Notes

### Why SQLite for Both Features?

Both F-124 and F-125 use SQLite storage:

1. **Zero configuration** - No database server needed
2. **Portable** - Database file travels with project
3. **Query capable** - Complex traversals and filters
4. **Transactional** - ACID guarantees for integrity
5. **Proven** - Battle-tested, widely deployed

### Hidden Commands

Both `variant` and `lineage` commands are registered as hidden:

```python
app.add_typer(variant_app, name="variant", hidden=True)
app.add_typer(lineage_app, name="lineage", hidden=True)
```

This keeps the main help output clean while making advanced features available to power users.

---

## Files Created

### F-124: Experiment Management
- `src/persona/core/experiments/sqlite_store.py` (NEW)
- `src/persona/ui/commands/variant.py` (NEW)
- `tests/unit/experiments/test_sqlite_store.py` (NEW)

### F-125: Data Lineage
- `src/persona/core/lineage/models.py` (NEW)
- `src/persona/core/lineage/hashing.py` (NEW)
- `src/persona/core/lineage/store.py` (NEW)
- `src/persona/core/lineage/sqlite_store.py` (NEW)
- `src/persona/core/lineage/__init__.py` (NEW)
- `src/persona/ui/commands/lineage.py` (NEW)
- `tests/unit/lineage/test_hashing.py` (NEW)
- `tests/unit/lineage/test_sqlite_store.py` (NEW)

---

## Related Documentation

- [v1.9.0 Retrospective](../retrospectives/v1.9.0-retrospective.md)
- [v1.9.0 Milestone](../../roadmap/milestones/v1.9.0.md)
- [F-124: Experiment Management](../../roadmap/features/completed/F-124-experiment-management.md)
- [F-125: Data Lineage](../../roadmap/features/completed/F-125-data-lineage-provenance.md)
- [DevLogs Index](README.md)

---

**Status**: Complete
