# DevLog: v0.5.0 - Extensibility + SDK

## Implementation Narrative

v0.5.0 marks a significant milestone in Persona's evolution from a CLI tool to a comprehensive platform. This release focuses on extensibility and programmatic access, laying the groundwork for integrating Persona into larger workflows and applications.

### The SDK Vision

The central piece of v0.5.0 is the Python SDK (F-087). Rather than treating the CLI as the primary interface, we inverted the architecture: the SDK provides the core programmatic interface, and the CLI wraps it. This "library-first" approach ensures that everything you can do from the command line, you can also do from Python code.

```python
from persona.sdk import PersonaSDK, GenerationConfig

sdk = PersonaSDK()
config = GenerationConfig(provider='anthropic', model='claude-sonnet-4-20250514')
result = await sdk.generate_async(data_path='./interviews.csv', config=config)
```

The async support (F-088) came naturally from this design. Python's asyncio integrates cleanly, enabling parallel generation for high-throughput scenarios.

### Configuration as Code

A major theme of v0.5.0 is treating configuration as code. Users can now define custom vendors, models, templates, and workflows as YAML files in a hierarchical structure:

- `~/.persona/` for user-level defaults
- `.persona/` for project-specific overrides

This mirrors patterns from tools like git, Docker, and npm that developers already understand. The template system uses Jinja2 with YAML front matter for metadata, allowing templates to declare their required variables and capabilities.

### Discovery and Transparency

The dynamic discovery features (F-047, F-048) bring transparency to what's available at runtime. Rather than relying on hardcoded lists, Persona can probe vendor endpoints and query model APIs to show what's actually accessible with the user's current configuration.

The discovery results are cached with a 5-minute TTL to balance freshness with performance. Force refresh is available when you need real-time data.

### Experiment Management Evolution

Building on v0.1.0's experiment foundation, this release adds comprehensive editing and history tracking:

- **Edit Command (F-049)**: Modify experiment configs without manual YAML editing. The `--set field=value` syntax is intuitive, and the rollback capability provides safety.

- **History Command (F-050)**: Track all generation runs with metadata (model, tokens, cost, duration). Compare runs with `--diff`, view statistics with `--stats`.

This transforms experiments from simple configuration containers to full audit trails of persona generation activity.

## Challenges Encountered

### Duplicate Feature IDs

During the documentation audit, we discovered that F-086 and F-087 each had two files with different content. The original features (CLI output modes and models command) conflicted with newer features (conversation scripts and Python SDK) that were added during planning.

**Resolution**: Renamed the newer features to F-092 and F-093. Added a mental note to implement uniqueness checking during the documentation phase.

### Template Metadata Extraction

Parsing YAML front matter from Jinja2 templates proved trickier than expected. The `---` delimiters can conflict with Jinja2 syntax in edge cases.

**Resolution**: Used a regex-based extraction that handles the common case, with fallback to treating the entire file as template content if parsing fails.

### Discovery Timeouts

Initial implementation of vendor discovery blocked for too long when probing unavailable endpoints. Users with no API keys configured would wait 10+ seconds for each provider to timeout.

**Resolution**: Reduced default timeout to 5 seconds and added aggressive connection timeout. Consider parallel probing in future versions.

## Code Highlights

### SDK Client Pattern

```python
class PersonaSDK:
    def __init__(self, provider: str = 'anthropic'):
        self._default_provider = provider
        self._manager = ExperimentManager()

    def generate(self, data_path, config=None, experiment=None):
        # Sync wrapper around async implementation
        return asyncio.run(self.generate_async(data_path, config, experiment))

    async def generate_async(self, data_path, config=None, experiment=None):
        # Core implementation
        ...
```

### Configuration Loader Pattern

```python
class VendorLoader:
    def __init__(self, user_dir=None, project_dir=None):
        self._user_dir = user_dir or Path.home() / '.persona' / 'vendors'
        self._project_dir = project_dir or Path('.persona') / 'vendors'

    def load(self, vendor_id: str) -> VendorConfig:
        # Project takes precedence over user
        for dir in [self._project_dir, self._user_dir]:
            path = dir / f'{vendor_id}.yaml'
            if path.exists():
                return VendorConfig.from_yaml(path.read_text())
        raise FileNotFoundError(f'Vendor not found: {vendor_id}')
```

### Edit History with Rollback

```python
class ExperimentEditor:
    def rollback(self, name: str, steps: int = 1):
        history = self.get_history(name)
        to_rollback = history[-steps:]

        for entry in reversed(to_rollback):
            if entry.action == 'update':
                setattr(config, entry.field, entry.old_value)
            elif entry.action == 'add_source':
                (exp.data_dir / entry.new_value).unlink()

        self._save_history(exp.path, history[:-steps])
```

## Dependencies Added

No new runtime dependencies. The SDK uses existing packages:
- `pydantic` for data validation
- `httpx` for HTTP operations in discovery
- `typer` and `rich` for CLI
- `jinja2` for templates

## Test Statistics

| Category | Count |
|----------|-------|
| Core SDK tests | 45 |
| Config tests (vendor/model/template/workflow) | 168 |
| Discovery tests | 36 |
| Experiment edit/history tests | 91 |
| CLI command tests | 187 |
| **Total new tests** | **527** |
| **Total test suite** | **1494** |

## Looking Ahead

v0.5.0 establishes the extensibility foundation. The next milestones build on this:

- **v0.6.0 (Security)**: API key protection, rate limiting, input validation
- **v0.7.0 (Batch Processing)**: Folder processing, context window awareness
- **v0.9.0 (REST API)**: HTTP server wrapping the SDK, webhooks

The SDK architecture means these features can be added incrementally without restructuring.

---

## Related Documentation

- [v0.5.0 Milestone](../../roadmap/milestones/v0.5.0.md)
- [v0.5.0 Retrospective](../retrospectives/v0.5.0-retrospective.md)
- [ADR-0021: Programmatic API](../../decisions/adrs/ADR-0021-programmatic-api.md)
