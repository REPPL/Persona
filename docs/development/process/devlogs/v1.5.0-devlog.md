# DevLog: v1.5.0 - Hybrid Pipeline

## Overview

v1.5.0 delivers the "Best of Both Worlds" milestone with a single focused feature enabling cost-optimised persona generation by combining local and frontier models.

## Feature Summary

| ID | Feature | Description |
|----|---------|-------------|
| F-116 | Hybrid Local/Frontier Pipeline | Orchestrate local drafts with frontier refinement |

## Implementation Narrative

### The Cost-Quality Trade-off

Users previously faced a binary choice:

| Approach | Cost | Privacy | Quality |
|----------|------|---------|---------|
| Frontier Only | High ($0.15-0.50/persona) | Low | Excellent (95%+) |
| Local Only | Free | High | Good (85-90%) |

The hybrid pipeline achieves the best of both: 90%+ quality at 50%+ cost reduction.

### Hybrid Pipeline Architecture

```
Input Data → PII Anonymisation → Local Draft Generation → Local Quality Filter
                                         ↓                        ↓
                                    N×2 Drafts              Top N Candidates
                                                                  ↓
                                                    [Optional] Frontier Refinement
                                                                  ↓
                                                          Final Personas
```

### Python API

```python
from persona.core.hybrid import HybridPipeline, HybridConfig

# Create hybrid pipeline
pipeline = HybridPipeline(
    local_provider="ollama",
    local_model="qwen2.5:72b",
    frontier_provider="anthropic",
    frontier_model="claude-sonnet-4-5-20250929"
)

# Generate with hybrid approach
result = pipeline.generate(
    data_path="research.csv",
    count=5,
    config=HybridConfig(
        draft_multiplier=2,      # Generate 2x candidates locally
        quality_threshold=0.75,  # Minimum quality for frontier refinement
        use_frontier=True,       # Enable frontier refinement
        max_frontier_cost=5.00,  # Budget cap in USD
    )
)

# Local-only mode (privacy-first)
result = pipeline.generate(
    data_path="sensitive.csv",
    count=5,
    config=HybridConfig(use_frontier=False)
)
```

### CLI Integration

```bash
# Generate with hybrid pipeline
persona generate --input research.csv --hybrid

# Specify models
persona generate --input research.csv --hybrid --local-model qwen2.5:72b --frontier anthropic

# Budget-constrained
persona generate --input research.csv --hybrid --max-cost 5.00

# Privacy mode (local only)
persona generate --input sensitive.csv --hybrid --no-frontier

# Cost estimation before run
persona generate --input research.csv --hybrid --estimate-only
```

## Technical Highlights

### Pipeline Configuration

```python
@dataclass
class HybridConfig:
    draft_multiplier: int = 2      # Drafts per final persona
    quality_threshold: float = 0.75 # Minimum quality for refinement
    use_frontier: bool = True       # Enable frontier refinement
    max_frontier_cost: float | None = None  # Budget cap (USD)
    anonymise_input: bool = True    # PII protection
```

### Pipeline Stages

```python
class HybridPipeline:
    def generate(self, data_path: Path, count: int, config: HybridConfig) -> HybridResult:
        # Stage 1: Data preparation
        data = self._load_and_prepare(data_path, config.anonymise_input)

        # Stage 2: Local draft generation (N × multiplier)
        drafts = self._generate_drafts(data, count * config.draft_multiplier)

        # Stage 3: Quality filtering with local judge
        candidates = self._filter_by_quality(drafts, count, config.quality_threshold)

        # Stage 4: Optional frontier refinement
        if config.use_frontier and self._within_budget(candidates, config.max_frontier_cost):
            final = self._refine_with_frontier(candidates)
        else:
            final = candidates

        # Stage 5: Return with cost report
        return HybridResult(
            personas=final,
            cost_report=self._calculate_costs(),
            quality_metrics=self._evaluate_final(final)
        )
```

### Cost Comparison Results

| Approach | 10 Personas | 100 Personas | Quality |
|----------|-------------|--------------|---------|
| Frontier Only | $2.00 | $20.00 | 95% |
| Hybrid (2× drafts) | $1.00 | $10.00 | 93% |
| Hybrid (3×, 0.85 threshold) | $0.60 | $6.00 | 91% |
| Local Only (70B) | $0.00 | $0.00 | 88% |

### Budget Enforcement

```python
def _within_budget(self, candidates: list[Persona], max_cost: float | None) -> bool:
    if max_cost is None:
        return True

    estimated = self._estimate_frontier_cost(candidates)
    if estimated > max_cost:
        logger.warning(
            f"Frontier refinement would cost ${estimated:.2f}, "
            f"exceeding budget of ${max_cost:.2f}. Using local-only."
        )
        return False
    return True
```

### Integration with v1.4.0 Features

The hybrid pipeline leverages both F-114 and F-115:

```python
# Uses F-114 PersonaJudge for quality filtering
self.judge = PersonaJudge(provider=local_provider, model=local_model)
candidates = [p for p in drafts if self.judge.evaluate(p).overall >= threshold]

# Uses F-113 PII detection for input anonymisation (optional)
if config.anonymise_input:
    data = self.anonymiser.anonymise(data)
```

## Testing

| Category | Tests |
|----------|-------|
| HybridPipeline | 28 |
| HybridConfig | 12 |
| Cost estimation | 15 |
| Budget enforcement | 10 |
| CLI integration | 8 |
| **Total milestone** | 73+ |

## Dependencies

- v1.4.0: F-114 (LLM-as-judge) for quality filtering
- v1.3.0: F-112 (Ollama provider) for local generation
- v1.3.0: F-113 (PII detection) for input anonymisation
- v0.7.0: F-071 (Cost estimation) for budget tracking

## Bug Fixes

### Cost Estimation Accuracy

**Issue**: Cost estimates didn't account for refinement prompt overhead.

**Fix**: Added refinement context to cost calculation:
```python
def _estimate_frontier_cost(self, candidates: list[Persona]) -> float:
    base_cost = sum(self._token_cost(p) for p in candidates)
    refinement_overhead = len(candidates) * self.refinement_prompt_tokens
    return base_cost + (refinement_overhead * self.frontier_cost_per_token)
```

### Graceful Fallback

**Issue**: Pipeline failed when Ollama wasn't running.

**Fix**: Detect and warn, with option to proceed frontier-only:
```python
if not self.local_provider.is_available():
    if config.use_frontier:
        logger.warning("Local provider unavailable, using frontier-only mode")
        return self._frontier_only_generate(data, count)
    raise LocalProviderUnavailable("Ollama not running and --no-frontier specified")
```

## Summary

v1.5.0 delivers cost-optimised persona generation:

- **50%+ cost reduction** vs frontier-only for bulk generation
- **90%+ quality** maintained through selective refinement
- **Privacy protection** with local-only mode for sensitive data
- **Budget controls** prevent unexpected costs
- **Graceful degradation** when local provider unavailable

The hybrid approach makes high-quality persona generation accessible to budget-conscious teams while maintaining privacy options.

---

## Related Documentation

- [v1.5.0 Milestone](../../roadmap/milestones/v1.5.0.md)
- [v1.5.0 Retrospective](../retrospectives/v1.5.0-retrospective.md)
- [F-116: Hybrid Local/Frontier Pipeline](../../roadmap/features/completed/F-116-hybrid-local-frontier-pipeline.md)
- [R-013: Local Model Assessment](../../research/R-013-local-model-assessment.md)

---

**Status**: Complete
