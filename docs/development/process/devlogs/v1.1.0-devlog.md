# DevLog: v1.1.0 - Quality & API

## Overview

v1.1.0 delivers the "Measure & Connect" milestone with six features enabling programmatic access, quality measurement, and enhanced output formats for persona generation.

## Feature Summary

| ID | Feature | Description |
|----|---------|-------------|
| F-088 | Async Support | Async generator for non-blocking operations |
| F-089 | REST API | FastAPI-based HTTP interface |
| F-090 | Webhooks | Event notifications for long-running jobs |
| F-104 | Conversation Scripts | Character cards and system prompts |
| F-105 | Python SDK | High-level programmatic interface |
| F-106 | Quality Metrics | Multi-dimensional quality scoring |

## Implementation Narrative

### Phase 1: Async Foundation (F-088)

The async support provides non-blocking persona generation:

```python
from persona.sdk import AsyncPersonaGenerator

generator = AsyncPersonaGenerator(provider="anthropic")
result = await generator.agenerate(
    data_path="./data.csv",
    config=PersonaConfig(count=5)
)
```

Key components:
- `AsyncPersonaGenerator` wraps sync operations with `asyncio.to_thread()`
- Progress callbacks work in async context
- Integration with existing provider infrastructure

### Phase 2: REST API (F-089)

FastAPI provides the HTTP interface:

```
POST /api/v1/generate          # Start generation job
GET  /api/v1/generate/{id}     # Get job status
GET  /api/v1/generate          # List all jobs
GET  /api/v1/health            # Health check
GET  /docs                     # OpenAPI documentation
```

Architecture:
```
persona/api/
├── app.py           # FastAPI application factory
├── config.py        # APIConfig (BaseSettings)
├── dependencies.py  # DI with auth verification
├── routes/          # Endpoint handlers
│   ├── generate.py
│   ├── webhooks.py
│   └── health.py
├── services/        # Business logic
│   ├── generation.py  # Job management
│   └── webhook.py     # Webhook delivery
├── models/          # Pydantic request/response
└── middleware/      # Rate limiting, logging
```

Authentication uses `X-API-Key` header:
```bash
curl -H "X-API-Key: secret" http://localhost:8000/api/v1/generate
```

### Phase 3: Webhooks (F-090)

Webhooks notify external systems of job events:

```python
# Register webhook
POST /api/v1/webhooks
{
    "url": "https://example.com/webhook",
    "events": ["generation.completed", "generation.failed"],
    "secret": "webhook-secret"
}

# Webhook payload
{
    "event": "generation.completed",
    "job_id": "job-abc123",
    "timestamp": "2024-12-15T14:30:22Z",
    "signature": "sha256=..."
}
```

Features:
- HMAC-SHA256 signature verification
- Configurable retry with exponential backoff
- Event filtering by subscription

### Phase 4: Conversation Scripts (F-104)

Generate character cards and system prompts from personas:

```bash
# Character card format
persona script --format character-card --input personas.json

# System prompt format
persona script --format system-prompt --template custom.j2
```

Output formats:
- `character-card`: LLM roleplay format with personality, scenario
- `system-prompt`: System message for AI assistants
- `jinja2`: Custom templates with full persona access

### Phase 5: Python SDK (F-105)

Two-tier SDK design:

**High-level: PersonaClient**
```python
from persona.sdk import PersonaClient

client = PersonaClient(provider="anthropic")
result = client.generate("./data.csv", count=5)
```

**Low-level: PersonaGenerator**
```python
from persona.sdk import PersonaGenerator, PersonaConfig

generator = PersonaGenerator(provider="anthropic")
result = generator.generate(
    data_path="./data.csv",
    config=PersonaConfig(
        count=5,
        complexity="detailed",
        include_reasoning=True
    )
)
```

Configuration hierarchy:
1. Constructor arguments (highest)
2. Environment variables (`PERSONA_*`)
3. Config file (`~/.persona/config.yaml`)
4. Defaults (lowest)

### Phase 6: Quality Metrics (F-106)

Five-dimensional quality scoring:

| Dimension | Weight | Measures |
|-----------|--------|----------|
| Completeness | 25% | Field population, depth, richness |
| Consistency | 20% | Internal coherence, no contradictions |
| Evidence | 25% | Grounding in source data |
| Distinctiveness | 15% | Uniqueness vs other personas |
| Realism | 15% | Plausibility, specificity |

```python
from persona.core.quality import QualityScorer

scorer = QualityScorer()
result = scorer.score(persona)

print(f"Overall: {result.overall_score:.1f}")
print(f"Level: {result.level.value}")  # excellent/good/acceptable/poor/failing
```

CLI with quality gates:
```bash
persona score ./personas.json --min-score 75
# Exit code 1 if any persona below threshold
```

## Technical Highlights

### Job-Based Async Generation

```python
class GenerationService:
    async def execute_job(self, job_id: str) -> None:
        job = self.get_job(job_id)
        job.status = JobStatus.RUNNING

        try:
            generator = AsyncPersonaGenerator(provider=job.provider)
            result = await generator.agenerate(...)

            job.status = JobStatus.COMPLETED
            job.result = result

            # Notify webhook
            if self.webhook_manager:
                await self.webhook_manager.notify_completed(job_id)
        except Exception as e:
            job.status = JobStatus.FAILED
            job.error = str(e)
```

### Webhook Signature Verification

```python
def verify_signature(payload: bytes, signature: str, secret: str) -> bool:
    expected = hmac.new(
        secret.encode(),
        payload,
        hashlib.sha256
    ).hexdigest()
    return hmac.compare_digest(f"sha256={expected}", signature)
```

### Quality Score Calculation

```python
def score(self, persona: Persona) -> QualityScore:
    dimensions = {}
    for metric in self._metrics:
        result = metric.evaluate(persona)
        dimensions[result.dimension] = result

    overall = sum(d.score * d.weight for d in dimensions.values())
    level = self._determine_level(overall)

    return QualityScore(
        overall_score=overall,
        level=level,
        dimensions=dimensions
    )
```

## Bug Fixes

### FastAPI Dependency Injection

**Issue**: Routes using `dependencies=[Depends(AuthDep)]` where `AuthDep` is `Annotated[None, Depends(verify_token)]` caused 422 validation errors.

**Cause**: Double-wrapping an annotated dependency in `Depends()` confuses FastAPI's parameter extraction.

**Fix**: Use `dependencies=[Depends(verify_token)]` directly instead of wrapping the annotated type.

```python
# Before (broken)
@router.post("/generate", dependencies=[Depends(AuthDep)])

# After (fixed)
@router.post("/generate", dependencies=[Depends(verify_token)])
```

## Testing

| Category | Tests |
|----------|-------|
| API endpoints | 14 |
| SDK client | 25+ |
| Async generator | 15+ |
| Quality metrics | 35 |
| Conversation scripts | 20+ |
| **Total** | 2654 |

All tests pass with 4 deprecation warnings (Pydantic `Config` class).

## Dependencies

```toml
[project.optional-dependencies]
api = [
    "fastapi>=0.115.0",
    "uvicorn[standard]>=0.32.0",
    "python-multipart>=0.0.12",
    "pydantic-settings>=2.0.0",
]
async = [
    "aiofiles>=24.1.0",
]
```

## CLI Commands Added

```bash
# Start API server
persona serve [--port 8000] [--auth-token TOKEN]

# Score persona quality
persona score INPUT [--min-score N] [--strict|--lenient]

# Generate conversation scripts
persona script [--format FORMAT] [--template FILE]
```

## Summary

v1.1.0 transforms Persona from a CLI tool into a programmable platform:

- **REST API** enables integration with any system
- **Webhooks** support event-driven architectures
- **SDK** provides clean programmatic access
- **Quality metrics** enable automated quality gates
- **Conversation scripts** extend output capabilities

The async foundation ensures responsive APIs while maintaining the simplicity of synchronous usage for CLI operations.

---

## Related Documentation

- [v1.1.0 Milestone](../../roadmap/milestones/v1.1.0.md)
- [v1.1.0 Retrospective](../retrospectives/v1.1.0-retrospective.md)
- [ADR-0021: Programmatic API](../../decisions/adrs/ADR-0021-programmatic-api.md)

---

**Status**: Complete
